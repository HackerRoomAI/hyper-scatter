<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viz Lab - Benchmarks</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: #4e79a7;
      margin-bottom: 10px;
    }

    h2 {
      color: #76b7b2;
      margin: 20px 0 10px;
      font-size: 1.2em;
    }

    .subtitle {
      color: #888;
      margin-bottom: 20px;
    }

    .controls {
      background: #252542;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      margin-bottom: 15px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-size: 12px;
      color: #888;
      text-transform: uppercase;
    }

    select, input {
      background: #1a1a2e;
      border: 1px solid #4a4a6a;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4e79a7;
    }

    button {
      background: #4e79a7;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:hover:not(:disabled) {
      background: #5a8ac4;
    }

    button:disabled {
      background: #4a4a6a;
      cursor: not-allowed;
    }

    button.secondary {
      background: #3a3a5a;
    }

    button.secondary:hover:not(:disabled) {
      background: #4a4a6a;
    }

    .progress-container {
      margin: 20px 0;
      display: none;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      height: 8px;
      background: #3a3a5a;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4e79a7, #76b7b2);
      transition: width 0.3s;
    }

    .progress-text {
      margin-top: 8px;
      font-size: 14px;
      color: #888;
    }

    .canvas-container {
      background: #252542;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 20px;
    }

    canvas {
      display: block;
      width: 100%;
      height: 400px;
      background: #1a1a2e;
      border-radius: 4px;
    }

    .results {
      background: #252542;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
    }

    .benchmark-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .benchmark-table th,
    .benchmark-table td {
      padding: 10px 12px;
      text-align: right;
      border-bottom: 1px solid #3a3a5a;
    }

    .benchmark-table th {
      background: #1a1a2e;
      color: #4e79a7;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
    }

    .benchmark-table td:first-child,
    .benchmark-table th:first-child {
      text-align: left;
    }

    .benchmark-table tr:hover td {
      background: rgba(78, 121, 167, 0.1);
    }

    .benchmark-table .good {
      color: #59a14f;
    }

    .benchmark-table .warning {
      color: #f28e2c;
    }

    .benchmark-table .bad {
      color: #e15759;
    }

    .json-output {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow: auto;
      margin-top: 15px;
    }

    .accuracy-results {
      margin-top: 20px;
    }

    .test-result {
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
    }

    .test-result.pass {
      background: rgba(89, 161, 79, 0.2);
      border-left: 3px solid #59a14f;
    }

    .test-result.fail {
      background: rgba(225, 87, 89, 0.2);
      border-left: 3px solid #e15759;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tab {
      padding: 8px 16px;
      background: #3a3a5a;
      border: none;
      color: #888;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .tab.active {
      background: #4e79a7;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Viz Lab - Performance Benchmarks</h1>
    <p class="subtitle">Measure rendering and interaction performance (WebGL candidate or Canvas2D reference â€” one at a time)</p>

    <div class="controls">
      <div class="control-row">
        <div class="control-group">
          <label>Renderer</label>
          <select id="rendererSelect">
            <option value="webgl" selected>WebGL Candidate</option>
            <option value="reference">Reference (Canvas2D)</option>
          </select>
        </div>

        <div class="control-group">
          <label>Point Counts</label>
          <select id="pointCountsSelect" multiple size="4">
            <option value="1000" selected>1,000</option>
            <option value="10000" selected>10,000</option>
            <option value="50000" selected>50,000</option>
            <option value="100000" selected>100,000</option>
            <option value="250000">250,000</option>
            <option value="500000">500,000</option>
            <option value="1000000">1,000,000</option>
            <option value="2000000">2,000,000</option>
            <option value="3000000">3,000,000</option>
            <option value="5000000">5,000,000</option>
            <option value="10000000">10,000,000</option>
            <option value="20000000">20,000,000</option>
          </select>
        </div>

        <div class="control-group">
          <label>Geometries</label>
          <select id="geometriesSelect" multiple size="2">
            <option value="euclidean" selected>Euclidean</option>
            <option value="poincare" selected>Poincare (Hyperbolic)</option>
          </select>
        </div>

        <div class="control-group">
          <label>Measured Frames</label>
          <input type="number" id="measuredFrames" value="20" min="5" max="100">
        </div>

        <div class="control-group">
          <label>Hit Test Samples</label>
          <input type="number" id="hitTestSamples" value="100" min="10" max="1000">
        </div>
      </div>

      <div class="control-row">
        <button id="runBenchmark">Run Performance Benchmark</button>
        <button id="runAccuracy" class="secondary">Run Accuracy Tests</button>
        <button id="copyResults" class="secondary" disabled>Copy JSON</button>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">Initializing...</div>
    </div>

    <div class="canvas-container">
      <canvas id="canvas"></canvas>
      <!-- Hidden canvas for candidate renderer (WebGL needs separate canvas from 2D) -->
      <canvas id="candidateCanvas" style="display: none;"></canvas>
    </div>

    <div class="results">
      <div class="tabs">
        <button class="tab active" data-tab="table">Results Table</button>
        <button class="tab" data-tab="json">JSON Output</button>
        <button class="tab" data-tab="accuracy">Accuracy Tests</button>
      </div>

      <div class="tab-content active" id="tableTab">
        <div id="resultsTable">
          <p style="color: #888; text-align: center; padding: 40px;">
            Click "Run Performance Benchmark" to start
          </p>
        </div>
      </div>

      <div class="tab-content" id="jsonTab">
        <div class="json-output" id="jsonOutput">
          // Results will appear here after running benchmarks
        </div>
      </div>

      <div class="tab-content" id="accuracyTab">
        <div id="accuracyResults">
          <p style="color: #888; text-align: center; padding: 40px;">
            Click "Run Accuracy Tests" to validate mathematical correctness
          </p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import './src/benchmarks/browser.ts';

    const canvas = document.getElementById('canvas');
    const candidateCanvas = document.getElementById('candidateCanvas');
    const runBenchmarkBtn = document.getElementById('runBenchmark');
    const runAccuracyBtn = document.getElementById('runAccuracy');
    const copyResultsBtn = document.getElementById('copyResults');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsTable = document.getElementById('resultsTable');
    const jsonOutput = document.getElementById('jsonOutput');
    const accuracyResults = document.getElementById('accuracyResults');

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });

    // Resize canvas to container
    function resizeCanvas() {
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      canvas.style.width = (rect.width - 20) + 'px';

      // Keep the candidate canvas in sync so toggling between renderers doesn't
      // change layout or break any code paths that rely on client sizes.
      if (candidateCanvas) {
        candidateCanvas.style.width = canvas.style.width;
      }
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    let lastReport = null;

    // Get config from UI
    function getConfig() {
      const rendererSelect = document.getElementById('rendererSelect');
      const pointCountsSelect = document.getElementById('pointCountsSelect');
      const geometriesSelect = document.getElementById('geometriesSelect');

      return {
        renderer: rendererSelect.value,
        pointCounts: Array.from(pointCountsSelect.selectedOptions).map(o => parseInt(o.value)),
        geometries: Array.from(geometriesSelect.selectedOptions).map(o => o.value),
        warmupFrames: 5,
        measuredFrames: parseInt(document.getElementById('measuredFrames').value),
        hitTestSamples: parseInt(document.getElementById('hitTestSamples').value),
      };
    }

    // Run benchmark
    runBenchmarkBtn.addEventListener('click', async () => {
      const config = getConfig();

      if (config.pointCounts.length === 0 || config.geometries.length === 0) {
        alert('Please select at least one point count and one geometry');
        return;
      }

      runBenchmarkBtn.disabled = true;
      runAccuracyBtn.disabled = true;
      progressContainer.classList.add('active');

      try {
        const report = await window.VizBenchmark.runBenchmarks(
          canvas,
          config,
          (message, progress) => {
            progressFill.style.width = (progress * 100) + '%';
            progressText.textContent = message;
          }
        );

        lastReport = report;

        // Show results
        resultsTable.innerHTML = window.VizBenchmark.formatResultsHTML(report);
        jsonOutput.textContent = JSON.stringify(report, null, 2);
        copyResultsBtn.disabled = false;

        // Also log to console
        console.log(window.VizBenchmark.formatResultsTable(report));
        console.log('Full report:', report);

      } catch (error) {
        console.error('Benchmark failed:', error);
        resultsTable.innerHTML = `<p style="color: #e15759; padding: 20px;">Benchmark failed: ${error.message}</p>`;
      } finally {
        runBenchmarkBtn.disabled = false;
        runAccuracyBtn.disabled = false;
        progressContainer.classList.remove('active');
      }
    });

    // Run accuracy tests
    runAccuracyBtn.addEventListener('click', async () => {
      runBenchmarkBtn.disabled = true;
      runAccuracyBtn.disabled = true;
      progressContainer.classList.add('active');

      try {
        const reports = await window.VizBenchmark.runAccuracyBenchmarks(
          canvas,
          (message, progress) => {
            progressFill.style.width = (progress * 100) + '%';
            progressText.textContent = message;
          }
        );

        // Format accuracy results
        let html = '';
        for (const report of reports) {
          html += `<h2>${report.geometry.toUpperCase()} Accuracy Tests</h2>`;
          html += `<p style="margin-bottom: 10px;">Result: <strong style="color: ${report.allPassed ? '#59a14f' : '#e15759'}">${report.summary}</strong></p>`;

          for (const test of report.tests) {
            const cls = test.passed ? 'pass' : 'fail';
            const status = test.passed ? '[PASS]' : '[FAIL]';
            html += `<div class="test-result ${cls}">`;
            html += `${status} ${test.operation}: maxError=${test.maxError.toExponential(2)}`;
            if (!test.passed && test.details) {
              html += `<br><small>${test.details}</small>`;
            }
            html += `</div>`;
          }
        }

        accuracyResults.innerHTML = html;

        // Switch to accuracy tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('[data-tab="accuracy"]').classList.add('active');
        document.getElementById('accuracyTab').classList.add('active');

        // Log to console
        for (const report of reports) {
          console.log(report);
        }

      } catch (error) {
        console.error('Accuracy tests failed:', error);
        accuracyResults.innerHTML = `<p style="color: #e15759; padding: 20px;">Accuracy tests failed: ${error.message}</p>`;
      } finally {
        runBenchmarkBtn.disabled = false;
        runAccuracyBtn.disabled = false;
        progressContainer.classList.remove('active');
      }
    });

    // Copy JSON
    copyResultsBtn.addEventListener('click', () => {
      if (lastReport) {
        navigator.clipboard.writeText(JSON.stringify(lastReport, null, 2));
        copyResultsBtn.textContent = 'Copied!';
        setTimeout(() => {
          copyResultsBtn.textContent = 'Copy JSON';
        }, 2000);
      }
    });
  </script>
</body>
</html>
