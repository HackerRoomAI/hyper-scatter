var Ue=Object.defineProperty;var Le=(o,t,e)=>t in o?Ue(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var u=(o,t,e)=>Le(o,typeof t!="symbol"?t+"":t,e);import"./modulepreload-polyfill-B5Qt9EMX.js";class Xe{constructor(t){u(this,"state");this.state=new Uint32Array(4);let e=t>>>0;for(let i=0;i<4;i++){e=e+2654435769>>>0;let s=e;s=(s^s>>>16)*2246822507>>>0,s=(s^s>>>13)*3266489909>>>0,s=(s^s>>>16)>>>0,this.state[i]=s}}random(){const t=this.rotl(this.state[1]*5,7)*9,e=this.state[1]<<9;return this.state[2]^=this.state[0],this.state[3]^=this.state[1],this.state[1]^=this.state[2],this.state[0]^=this.state[3],this.state[2]^=e,this.state[3]=this.rotl(this.state[3],11),(t>>>0)/4294967296}range(t,e){return t+this.random()*(e-t)}int(t){return Math.floor(this.random()*t)}gaussian(t=0,e=1){const i=Math.max(this.random(),1e-10),s=this.random(),n=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*s);return t+n*e}rotl(t,e){return(t<<e|t>>>32-e)>>>0}}const Ye=2e6;function Tt(o,t=0,e=1){const s=(o.random()+o.random()+o.random()+o.random()+o.random()+o.random()-3)*1.4142135623730951;return t+s*e}function ze(o,t,e,i,s){for(let r=0;r<t;r++){const a=Math.sqrt(o.random())*.92,c=o.range(0,2*Math.PI),l=a*Math.cos(c),d=a*Math.sin(c);e[r]=l,i[r]=d;const h=l*l+d*d;s[r]=.3*.5*(1-h)}}function Ne(o){const t=new Xe(o.seed),e=new Float32Array(o.n*2),i=new Uint16Array(o.n),s=o.n>=Ye,n=o.distribution??"default";if(o.geometry==="euclidean"){const r=[];for(let a=0;a<o.labelCount;a++)r.push({x:t.range(-1,1),y:t.range(-1,1)});for(let a=0;a<o.n;a++){const c=t.int(o.labelCount),l=r[c],d=s?Tt(t,0,.15):t.gaussian(0,.15),h=s?Tt(t,0,.15):t.gaussian(0,.15);e[a*2]=l.x+d,e[a*2+1]=l.y+h,i[a]=c}}else{if(n==="clustered"){const l=new Float32Array(o.labelCount),d=new Float32Array(o.labelCount),h=new Float32Array(o.labelCount);ze(t,o.labelCount,l,d,h);for(let f=0;f<o.n;f++){const p=t.int(o.labelCount),g=h[p],x=s?Tt(t,0,g):t.gaussian(0,g),m=s?Tt(t,0,g):t.gaussian(0,g);let b=l[p]+x,S=d[p]+m;const v=b*b+S*S;if(v>=1){const E=.999/Math.sqrt(v);b*=E,S*=E}e[f*2]=b,e[f*2+1]=S,i[f]=p}return{n:o.n,positions:e,labels:i,geometry:o.geometry}}const r=s?4096:0,a=r?new Float32Array(r):null,c=r?new Float32Array(r):null;if(r&&a&&c)for(let l=0;l<r;l++){const d=l/r*2*Math.PI;a[l]=Math.cos(d),c[l]=Math.sin(d)}for(let l=0;l<o.n;l++){const d=t.int(o.labelCount);let h;if(o.boundaryStress?h=t.range(.9,.999):h=Math.sqrt(t.random())*.95,r&&a&&c){const f=t.int(r);e[l*2]=h*a[f],e[l*2+1]=h*c[f]}else{const f=t.range(0,2*Math.PI);e[l*2]=h*Math.cos(f),e[l*2+1]=h*Math.sin(f)}i[l]=d}}return{n:o.n,positions:e,labels:i,geometry:o.geometry}}const Vt=["#4e79a7","#f28e2c","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7","#9c755f","#bab0ab"],dt="#ff0000",qt="#ffffff";function ut(o,t){return{kind:"indices",indices:o,computeTimeMs:t,has:e=>o.has(e)}}function me(o,t,e,i){return{kind:"geometry",geometry:o,computeTimeMs:e,has:s=>{const n=t[s*2],r=t[s*2+1];return i(n,r,o.coords)}}}function pe(){return{type:"euclidean",centerX:0,centerY:0,zoom:1}}function K(o,t,e,i,s){const n=Math.min(i,s)*.4*e.zoom,r=i/2+(o-e.centerX)*n,a=s/2-(t-e.centerY)*n;return{x:r,y:a}}function lt(o,t,e,i,s){const n=Math.min(i,s)*.4*e.zoom,r=e.centerX+(o-i/2)/n,a=e.centerY-(t-s/2)/n;return{x:r,y:a}}function xe(o,t,e,i,s){const n=Math.min(i,s)*.4*o.zoom;return{...o,centerX:o.centerX-t/n,centerY:o.centerY+e/n}}function ge(o,t,e,i,s,n){const r=lt(t,e,o,s,n),a=Math.pow(1.1,i),c=Math.max(.1,Math.min(100,o.zoom*a)),l=Math.min(s,n)*.4*c,d=r.x-(t-s/2)/l,h=r.y+(e-n/2)/l;return{...o,centerX:d,centerY:h,zoom:c}}function Ft(o,t,e){const i=e.length/2;if(i<3)return!1;let s=!1;for(let n=0,r=i-1;n<i;r=n++){const a=e[n*2],c=e[n*2+1],l=e[r*2],d=e[r*2+1];if(We(o,t,a,c,l,d,1e-9))return!0;if(c>t!=d>t){const h=(l-a)*(t-c)/(d-c)+a;o<h&&(s=!s)}}return s}function We(o,t,e,i,s,n,r){const a=Math.min(e,s)-r,c=Math.max(e,s)+r,l=Math.min(i,n)-r,d=Math.max(i,n)+r;if(o<a||o>c||t<l||t>d)return!1;const h=s-e,f=n-i,p=h*h+f*f;if(p<r*r)return Math.sqrt((o-e)*(o-e)+(t-i)*(t-i))<=r;const g=Math.max(0,Math.min(1,((o-e)*h+(t-i)*f)/p)),x=e+g*h,m=i+g*f;return Math.sqrt((o-x)*(o-x)+(t-m)*(t-m))<=r}function be(o,t){const e=new Set,i=o.length/2;for(let s=0;s<i;s++){const n=o[s*2],r=o[s*2+1];Ft(n,r,t)&&e.add(s)}return e}class Ge{constructor(){u(this,"canvas");u(this,"ctx");u(this,"width",0);u(this,"height",0);u(this,"dpr",1);u(this,"dataset",null);u(this,"view",pe());u(this,"selection",new Set);u(this,"hoveredIndex",-1);u(this,"pointRadius",3);u(this,"colors",Vt);u(this,"backgroundColor","#0a0a0a")}init(t,e){this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Failed to get 2D context");this.ctx=i,this.width=e.width,this.height=e.height,this.dpr=e.devicePixelRatio??1,e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.pointRadius&&(this.pointRadius=e.pointRadius),e.colors&&(this.colors=e.colors),t.width=this.width*this.dpr,t.height=this.height*this.dpr,t.style.width=`${this.width}px`,t.style.height=`${this.height}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}setDataset(t){if(t.geometry!=="euclidean")throw new Error("EuclideanReference only supports euclidean geometry");this.dataset=t,this.selection.clear(),this.hoveredIndex=-1,this.fitToData()}fitToData(){if(!this.dataset||this.dataset.n===0)return;let t=1/0,e=-1/0,i=1/0,s=-1/0;for(let l=0;l<this.dataset.n;l++){const d=this.dataset.positions[l*2],h=this.dataset.positions[l*2+1];t=Math.min(t,d),e=Math.max(e,d),i=Math.min(i,h),s=Math.max(s,h)}const n=e-t||1,r=s-i||1,c=2/Math.max(n,r);this.view={type:"euclidean",centerX:(t+e)/2,centerY:(i+s)/2,zoom:Math.max(.1,Math.min(100,c))}}setView(t){if(t.type!=="euclidean")throw new Error("EuclideanReference only supports euclidean view state");this.view=t}getView(){return{...this.view}}setSelection(t){this.selection=new Set(t)}getSelection(){return new Set(this.selection)}setHovered(t){this.hoveredIndex=t}render(){const{ctx:t,width:e,height:i,dataset:s,view:n}=this;if(!s)return;t.fillStyle=this.backgroundColor,t.fillRect(0,0,e,i);const{positions:r,labels:a,n:c}=s,l=this.pointRadius;for(let d=0;d<c;d++){if(this.selection.has(d)||d===this.hoveredIndex)continue;const h=r[d*2],f=r[d*2+1],p=K(h,f,n,e,i);p.x<-l||p.x>e+l||p.y<-l||p.y>i+l||(t.fillStyle=this.colors[a[d]%this.colors.length],t.beginPath(),t.arc(p.x,p.y,l,0,Math.PI*2),t.fill())}t.fillStyle=dt;for(const d of this.selection){if(d===this.hoveredIndex)continue;const h=r[d*2],f=r[d*2+1],p=K(h,f,n,e,i);t.beginPath(),t.arc(p.x,p.y,l+1,0,Math.PI*2),t.fill()}if(this.hoveredIndex>=0&&this.hoveredIndex<c){const d=this.hoveredIndex,h=r[d*2],f=r[d*2+1],p=K(h,f,n,e,i);t.strokeStyle=qt,t.lineWidth=2,t.beginPath(),t.arc(p.x,p.y,l+3,0,Math.PI*2),t.stroke(),t.fillStyle=this.selection.has(d)?dt:this.colors[a[d]%this.colors.length],t.beginPath(),t.arc(p.x,p.y,l+1,0,Math.PI*2),t.fill()}}resize(t,e){this.width=t,this.height=e,this.canvas.width=t*this.dpr,this.canvas.height=e*this.dpr,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}destroy(){}pan(t,e,i){this.view=xe(this.view,t,e,this.width,this.height)}zoom(t,e,i,s){this.view=ge(this.view,t,e,i,this.width,this.height)}hitTest(t,e){if(!this.dataset)return null;const{positions:i,n:s}=this.dataset;let n=-1,r=1/0;const a=(this.pointRadius+5)**2;for(let h=0;h<s;h++){const f=i[h*2],p=i[h*2+1],g=K(f,p,this.view,this.width,this.height),x=g.x-t,m=g.y-e,b=x*x+m*m;b<r&&b<=a&&(r=b,n=h)}if(n<0)return null;const c=i[n*2],l=i[n*2+1],d=K(c,l,this.view,this.width,this.height);return{index:n,screenX:d.x,screenY:d.y,distance:Math.sqrt(r)}}lassoSelect(t){if(!this.dataset)return ut(new Set,0);const e=performance.now(),i=new Float32Array(t.length);for(let r=0;r<t.length/2;r++){const a=t[r*2],c=t[r*2+1],l=lt(a,c,this.view,this.width,this.height);i[r*2]=l.x,i[r*2+1]=l.y}const s=be(this.dataset.positions,i),n=performance.now()-e;return ut(s,n)}async countSelection(t,e={}){if(!t.indices)throw new Error("EuclideanReference.countSelection expects indices-based selections");return t.indices.size}projectToScreen(t,e){return K(t,e,this.view,this.width,this.height)}unprojectFromScreen(t,e){return lt(t,e,this.view,this.width,this.height)}}function Mt(){return{type:"poincare",ax:0,ay:0,displayZoom:1}}function ye(o,t,e,i){const s=o-e,n=t-i,r=1-(e*o+i*t),a=-(e*t-i*o),c=r*r+a*a;if(c<1e-12){const f=Math.sqrt(s*s+n*n);return f<1e-12?{x:0,y:0}:{x:s/f*.999,y:n/f*.999}}const l=(s*r+n*a)/c,d=(n*r-s*a)/c,h=l*l+d*d;if(h>=1){const f=Math.sqrt(h);return{x:l/f*.999,y:d/f*.999}}return{x:l,y:d}}function It(o,t,e,i){const s=o+e,n=t+i,r=1+(e*o+i*t),a=e*t-i*o,c=r*r+a*a;if(c<1e-12){const f=Math.sqrt(s*s+n*n);return f<1e-12?{x:0,y:0}:{x:s/f*.999,y:n/f*.999}}const l=(s*r+n*a)/c,d=(n*r-s*a)/c,h=l*l+d*d;if(h>=1){const f=Math.sqrt(h);return{x:l/f*.999,y:d/f*.999}}return{x:l,y:d}}function tt(o,t,e,i,s){const n=ye(o,t,e.ax,e.ay),r=Math.min(i,s)*.45*e.displayZoom,a=i/2+n.x*r,c=s/2-n.y*r;return{x:a,y:c}}function ct(o,t,e,i,s){const n=Math.min(i,s)*.45*e.displayZoom,r=(o-i/2)/n,a=-(t-s/2)/n,c=r*r+a*a;if(c>=1){const l=Math.sqrt(c),d=r/l*.999,h=a/l*.999;return It(d,h,e.ax,e.ay)}return It(r,a,e.ax,e.ay)}function Ve(o,t,e,i){const s=e*o-i*t,n=e*t+i*o,r=s*s+n*n-1;if(Math.abs(r)<1e-10)return{x:-e,y:-i};const a=o-e,c=i-t,l=(-(1+s)*a+n*c)/r,d=((1-s)*c-n*a)/r,h=l*l+d*d;if(h>=1){const f=Math.sqrt(h);return{x:l/f*.99,y:d/f*.99}}return{x:l,y:d}}function Ot(o,t,e,i,s,n,r){const a=Math.min(n,r)*.45*o.displayZoom,c=(t-n/2)/a,l=-(e-r/2)/a,d=(i-n/2)/a,h=-(s-r/2)/a,f=(b,S,v=.95)=>{const E=b*b+S*S;if(E>v*v){const R=Math.sqrt(E);return{x:b/R*v,y:S/R*v}}return{x:b,y:S}},p=f(c,l),g=f(d,h),x=It(p.x,p.y,o.ax,o.ay),m=Ve(x.x,x.y,g.x,g.y);return{...o,ax:m.x,ay:m.y}}function Se(o,t,e,i,s,n){const r=Math.pow(1.1,i),a=Math.max(.5,Math.min(10,o.displayZoom*r)),c=ct(t,e,o,s,n),l=Math.min(s,n)*.45*a,d=ye(c.x,c.y,o.ax,o.ay),h=s/2+d.x*l,f=n/2-d.y*l,p=h-t,g=f-e;return Math.abs(p)>.5||Math.abs(g)>.5?Ot({...o,displayZoom:a},h,f,t,e,s,n):{...o,displayZoom:a}}class qe{constructor(){u(this,"canvas");u(this,"ctx");u(this,"width",0);u(this,"height",0);u(this,"dpr",1);u(this,"dataset",null);u(this,"view",Mt());u(this,"selection",new Set);u(this,"hoveredIndex",-1);u(this,"pointRadius",3);u(this,"colors",Vt);u(this,"backgroundColor","#0a0a0a");u(this,"poincareDiskFillColor","#141414");u(this,"poincareDiskBorderColor","#666666");u(this,"poincareGridColor","#2a2a2a");u(this,"poincareDiskBorderWidthPx",2);u(this,"poincareGridWidthPx",.5);u(this,"lastPanScreenX",0);u(this,"lastPanScreenY",0);u(this,"hasPanAnchor",!1)}init(t,e){this.canvas=t;const i=t.getContext("2d");if(!i)throw new Error("Failed to get 2D context");this.ctx=i,this.width=e.width,this.height=e.height,this.dpr=e.devicePixelRatio??1,e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.pointRadius&&(this.pointRadius=e.pointRadius),e.colors&&(this.colors=e.colors),e.poincareDiskFillColor&&(this.poincareDiskFillColor=e.poincareDiskFillColor),e.poincareDiskBorderColor&&(this.poincareDiskBorderColor=e.poincareDiskBorderColor),e.poincareGridColor&&(this.poincareGridColor=e.poincareGridColor),typeof e.poincareDiskBorderWidthPx=="number"&&Number.isFinite(e.poincareDiskBorderWidthPx)&&(this.poincareDiskBorderWidthPx=Math.max(0,e.poincareDiskBorderWidthPx)),typeof e.poincareGridWidthPx=="number"&&Number.isFinite(e.poincareGridWidthPx)&&(this.poincareGridWidthPx=Math.max(0,e.poincareGridWidthPx)),t.width=this.width*this.dpr,t.height=this.height*this.dpr,t.style.width=`${this.width}px`,t.style.height=`${this.height}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}setDataset(t){if(t.geometry!=="poincare")throw new Error("HyperbolicReference only supports poincare geometry");this.dataset=t,this.selection.clear(),this.hoveredIndex=-1,this.view=Mt()}setView(t){if(t.type!=="poincare")throw new Error("HyperbolicReference only supports poincare view state");this.view=t}getView(){return{...this.view}}setSelection(t){this.selection=new Set(t)}getSelection(){return new Set(this.selection)}setHovered(t){this.hoveredIndex=t}render(){const{ctx:t,width:e,height:i,dataset:s,view:n}=this;if(!s)return;t.fillStyle=this.backgroundColor,t.fillRect(0,0,e,i);const r=Math.min(e,i)*.45*n.displayZoom,a=e/2,c=i/2;t.fillStyle=this.poincareDiskFillColor,t.beginPath(),t.arc(a,c,r,0,Math.PI*2),t.fill(),t.strokeStyle=this.poincareDiskBorderColor,t.lineWidth=this.poincareDiskBorderWidthPx,t.beginPath(),t.arc(a,c,r,0,Math.PI*2),t.stroke(),this.drawHyperbolicGrid(t,a,c,r);const{positions:l,labels:d,n:h}=s,f=this.pointRadius;for(let p=0;p<h;p++){if(this.selection.has(p)||p===this.hoveredIndex)continue;const g=l[p*2],x=l[p*2+1],m=tt(g,x,n,e,i),b=m.x-a,S=m.y-c;b*b+S*S>r*r||(t.fillStyle=this.colors[d[p]%this.colors.length],t.beginPath(),t.arc(m.x,m.y,f,0,Math.PI*2),t.fill())}t.fillStyle=dt;for(const p of this.selection){if(p===this.hoveredIndex)continue;const g=l[p*2],x=l[p*2+1],m=tt(g,x,n,e,i);t.beginPath(),t.arc(m.x,m.y,f+1,0,Math.PI*2),t.fill()}if(this.hoveredIndex>=0&&this.hoveredIndex<h){const p=this.hoveredIndex,g=l[p*2],x=l[p*2+1],m=tt(g,x,n,e,i);t.strokeStyle=qt,t.lineWidth=2,t.beginPath(),t.arc(m.x,m.y,f+3,0,Math.PI*2),t.stroke(),t.fillStyle=this.selection.has(p)?dt:this.colors[d[p]%this.colors.length],t.beginPath(),t.arc(m.x,m.y,f+1,0,Math.PI*2),t.fill()}}drawHyperbolicGrid(t,e,i,s){t.strokeStyle=this.poincareGridColor,t.lineWidth=this.poincareGridWidthPx;const n=8;for(let a=0;a<n;a++){const c=a/n*Math.PI;t.beginPath(),t.moveTo(e-s*Math.cos(c),i-s*Math.sin(c)),t.lineTo(e+s*Math.cos(c),i+s*Math.sin(c)),t.stroke()}const r=5;for(let a=1;a<=r;a++){const c=a/(r+1)*s;t.beginPath(),t.arc(e,i,c,0,Math.PI*2),t.stroke()}}resize(t,e){this.width=t,this.height=e,this.canvas.width=t*this.dpr,this.canvas.height=e*this.dpr,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`,this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.dpr,this.dpr)}destroy(){}pan(t,e,i){this.hasPanAnchor||(this.lastPanScreenX=this.width/2,this.lastPanScreenY=this.height/2,this.hasPanAnchor=!0);const s=this.lastPanScreenX,n=this.lastPanScreenY,r=s+t,a=n+e;this.view=Ot(this.view,s,n,r,a,this.width,this.height),this.lastPanScreenX=r,this.lastPanScreenY=a}startPan(t,e){this.lastPanScreenX=t,this.lastPanScreenY=e,this.hasPanAnchor=!0}zoom(t,e,i,s){this.view=Se(this.view,t,e,i,this.width,this.height)}hitTest(t,e){if(!this.dataset)return null;const{positions:i,n:s}=this.dataset,{view:n,width:r,height:a}=this,c=r/2,l=a/2,d=Math.min(r,a)*.45*n.displayZoom;let h=-1,f=1/0;const p=(this.pointRadius+5)**2;for(let b=0;b<s;b++){const S=i[b*2],v=i[b*2+1],E=tt(S,v,n,r,a),R=E.x-c,M=E.y-l;if(R*R+M*M>d*d)continue;const F=E.x-t,C=E.y-e,P=F*F+C*C;P<f&&P<=p&&(f=P,h=b)}if(h<0)return null;const g=i[h*2],x=i[h*2+1],m=tt(g,x,n,r,a);return{index:h,screenX:m.x,screenY:m.y,distance:Math.sqrt(f)}}lassoSelect(t){if(!this.dataset)return ut(new Set,0);const e=performance.now(),i=new Float32Array(t.length);for(let r=0;r<t.length/2;r++){const a=t[r*2],c=t[r*2+1],l=ct(a,c,this.view,this.width,this.height);i[r*2]=l.x,i[r*2+1]=l.y}const s=be(this.dataset.positions,i),n=performance.now()-e;return ut(s,n)}async countSelection(t,e={}){if(!t.indices)throw new Error("HyperbolicReference.countSelection expects indices-based selections");return t.indices.size}projectToScreen(t,e){return tt(t,e,this.view,this.width,this.height)}unprojectFromScreen(t,e){return ct(t,e,this.view,this.width,this.height)}}function Y(o,t,e){return o<t?t:o>e?e:o|0}function Oe(o,t,e){return Math.max(t,Math.min(e,o))}function He(o){let t=1/0,e=1/0,i=-1/0,s=-1/0;for(let r=0;r<o.length;r+=2){const a=o[r],c=o[r+1];a<t&&(t=a),a>i&&(i=a),c<e&&(e=c),c>s&&(s=c)}if(!Number.isFinite(t)||!Number.isFinite(e))return{minX:0,minY:0,maxX:0,maxY:0};const n=1e-9;return Math.abs(i-t)<n&&(i=t+1),Math.abs(s-e)<n&&(s=e+1),{minX:t,minY:e,maxX:i,maxY:s}}class Ze{constructor(t,e,i=64){u(this,"n");u(this,"bounds");u(this,"cellsX");u(this,"cellsY");u(this,"cellSizeX");u(this,"cellSizeY");u(this,"offsets");u(this,"ids");this.n=t.length/2|0,this.bounds=e??He(t);const s=this.bounds.maxX-this.bounds.minX,n=this.bounds.maxY-this.bounds.minY,r=Oe(Math.ceil(this.n/Math.max(1,i)),64,1e6),a=s/n;let c=Math.round(Math.sqrt(r*a));c=Y(c,8,2048);let l=Math.round(r/c);l=Y(l,8,2048),this.cellsX=c,this.cellsY=l,this.cellSizeX=s/c,this.cellSizeY=n/l;const d=c*l,h=new Uint32Array(d);for(let m=0;m<this.n;m++){const b=t[m*2],S=t[m*2+1],v=Y(Math.floor((b-this.bounds.minX)/this.cellSizeX),0,c-1),E=Y(Math.floor((S-this.bounds.minY)/this.cellSizeY),0,l-1);h[E*c+v]++}const f=new Uint32Array(d+1);let p=0;for(let m=0;m<d;m++)f[m]=p,p+=h[m];f[d]=p;const g=f.slice(0,d),x=new Uint32Array(this.n);for(let m=0;m<this.n;m++){const b=t[m*2],S=t[m*2+1],v=Y(Math.floor((b-this.bounds.minX)/this.cellSizeX),0,c-1),R=Y(Math.floor((S-this.bounds.minY)/this.cellSizeY),0,l-1)*c+v,M=g[R]++;x[M]=m}this.offsets=f,this.ids=x}forEachInAABB(t,e,i,s,n){t-=1e-12,e-=1e-12,i+=1e-12,s+=1e-12;const a=Y(Math.floor((t-this.bounds.minX)/this.cellSizeX),0,this.cellsX-1),c=Y(Math.floor((e-this.bounds.minY)/this.cellSizeY),0,this.cellsY-1),l=Y(Math.floor((i-this.bounds.minX)/this.cellSizeX),0,this.cellsX-1),d=Y(Math.floor((s-this.bounds.minY)/this.cellSizeY),0,this.cellsY-1);for(let h=c;h<=d;h++){const f=h*this.cellsX;for(let p=a;p<=l;p++){const g=f+p,x=this.offsets[g],m=this.offsets[g+1];for(let b=x;b<m;b++)n(this.ids[b])}}}queryRadius(t,e,i,s){s.length=0,this.forEachInAABB(t-i,e-i,t+i,e+i,n=>s.push(n))}}function z(o){const t=o.trim();if(!t.startsWith("#"))return[1,1,1,1];const e=t.slice(1);if(e.length===3){const i=parseInt(e[0]+e[0],16)/255,s=parseInt(e[1]+e[1],16)/255,n=parseInt(e[2]+e[2],16)/255;return[i,s,n,1]}if(e.length===6||e.length===8){const i=parseInt(e.slice(0,2),16)/255,s=parseInt(e.slice(2,4),16)/255,n=parseInt(e.slice(4,6),16)/255,r=e.length===8?parseInt(e.slice(6,8),16)/255:1;return[i,s,n,r]}return[1,1,1,1]}function Ke(o){const t=o.trim();if(!t.startsWith("#"))return[255,255,255,255];const e=t.slice(1);if(e.length===3){const i=parseInt(e[0]+e[0],16),s=parseInt(e[1]+e[1],16),n=parseInt(e[2]+e[2],16);return[i,s,n,255]}if(e.length===6||e.length===8){const i=parseInt(e.slice(0,2),16),s=parseInt(e.slice(2,4),16),n=parseInt(e.slice(4,6),16),r=e.length===8?parseInt(e.slice(6,8),16):255;return[i,s,n,r]}return[255,255,255,255]}function oe(o,t,e){const i=o.createShader(t);if(!i)throw new Error("Failed to create shader");if(o.shaderSource(i,e),o.compileShader(i),!o.getShaderParameter(i,o.COMPILE_STATUS)){const s=o.getShaderInfoLog(i)??"unknown";throw o.deleteShader(i),new Error(`Shader compile failed: ${s}`)}return i}function xt(o,t,e){const i=oe(o,o.VERTEX_SHADER,t),s=oe(o,o.FRAGMENT_SHADER,e),n=o.createProgram();if(!n)throw new Error("Failed to create program");if(o.attachShader(n,i),o.attachShader(n,s),o.linkProgram(n),o.deleteShader(i),o.deleteShader(s),!o.getProgramParameter(n,o.LINK_STATUS)){const r=o.getProgramInfoLog(n)??"unknown";throw o.deleteProgram(n),new Error(`Program link failed: ${r}`)}return n}function ne(o,t,e,i){o.width=Math.max(1,Math.floor(t*i)),o.height=Math.max(1,Math.floor(e*i)),o.style.width=`${t}px`,o.style.height=`${e}px`}const $e=`#version 300 es
precision highp float;
precision highp int;

flat in uint v_label;

// Present in the vertex stage too; redeclare here so we can compute AA width.
uniform float u_dpr;
uniform float u_pointRadiusCss;

uniform sampler2D u_paletteTex;
uniform int u_paletteSize;
uniform int u_paletteWidth;

out vec4 outColor;

void main() {
  vec2 p = gl_PointCoord * 2.0 - 1.0;
  // Anti-aliased circle: avoid harsh discard edges that can look like
  // "weird polygons" at small sizes or without MSAA.
  float r = length(p);
  // Ensure at least ~1px transition (in point-local coordinates) so small
  // points remain visually circular.
  float radiusPx = max(u_pointRadiusCss * u_dpr, 1.0);
  // Slightly wider than 1px helps circles stay round-looking when zoomed out
  // (where points are perceptually tiny and aliasing is more obvious).
  float aa = max(fwidth(r), 1.5 / radiusPx);
  float alpha = 1.0 - smoothstep(1.0 - aa, 1.0 + aa, r);
  if (alpha <= 0.0) discard;

  int size = max(u_paletteSize, 1);
  int w = max(u_paletteWidth, 1);
  int idx = int(v_label) % size;
  int x = idx % w;
  int y = idx / w;
  vec4 c = texelFetch(u_paletteTex, ivec2(x, y), 0);
  outColor = vec4(c.rgb, c.a * alpha);
}
`,je=`#version 300 es
precision highp float;
precision highp int;

flat in uint v_label;

uniform sampler2D u_paletteTex;
uniform int u_paletteSize;
uniform int u_paletteWidth;

out vec4 outColor;

void main() {
  int size = max(u_paletteSize, 1);
  int w = max(u_paletteWidth, 1);
  int idx = int(v_label) % size;
  int x = idx % w;
  int y = idx / w;
  outColor = texelFetch(u_paletteTex, ivec2(x, y), 0);
}
`,Je=`#version 300 es
precision highp float;
precision highp int;

uniform float u_dpr;
uniform float u_pointRadiusCss;

uniform vec4 u_color;
uniform float u_pointSizePx;
uniform float u_ringThicknessPx;
uniform int u_ringMode; // 0 = solid, 1 = ring

out vec4 outColor;

void main() {
  vec2 p = gl_PointCoord * 2.0 - 1.0;
  float r = length(p);
  float radiusPx = max(u_pointRadiusCss * u_dpr, 1.0);
  float aa = max(fwidth(r), 1.5 / radiusPx);
  float outer = 1.0 - smoothstep(1.0 - aa, 1.0 + aa, r);
  if (outer <= 0.0) discard;

  float alpha = outer;

  if (u_ringMode == 1) {
    float radiusPx = u_pointSizePx * 0.5;
    float t = clamp(u_ringThicknessPx / max(radiusPx, 1e-6), 0.0, 1.0);
    float inner = 1.0 - t;
    // Keep only the outer ring with an anti-aliased inner boundary.
    float innerMask = smoothstep(inner - aa, inner + aa, r);
    alpha *= innerMask;
    if (alpha <= 0.0) discard;
  }

  outColor = vec4(u_color.rgb, u_color.a * alpha);
}
`,re=`#version 300 es
precision highp float;

out vec2 v_uv;

void main() {
  // Fullscreen triangle
  // (-1,-1), (3,-1), (-1,3)
  if (gl_VertexID == 0) {
    gl_Position = vec4(-1.0, -1.0, 0.0, 1.0);
    v_uv = vec2(0.0, 0.0);
  } else if (gl_VertexID == 1) {
    gl_Position = vec4(3.0, -1.0, 0.0, 1.0);
    v_uv = vec2(2.0, 0.0);
  } else {
    gl_Position = vec4(-1.0, 3.0, 0.0, 1.0);
    v_uv = vec2(0.0, 2.0);
  }
}
`,Qe=`#version 300 es
precision highp float;

in vec2 v_uv;

uniform sampler2D u_tex;

out vec4 outColor;

void main() {
  vec2 uv = clamp(v_uv, 0.0, 1.0);
  outColor = texture(u_tex, uv);
}
`,ti=`#version 300 es
precision highp float;
precision highp int;

uniform vec2 u_cssSize;
uniform float u_dpr;
uniform float u_displayZoom;

uniform vec4 u_diskFillColor;
uniform vec4 u_diskBorderColor;
uniform vec4 u_gridColor;
uniform float u_diskBorderWidthPx;
uniform float u_gridWidthPx;

out vec4 outColor;

void main() {
  // Convert framebuffer pixels to CSS pixels
  vec2 fragCss = gl_FragCoord.xy / max(u_dpr, 1.0);
  vec2 center = u_cssSize * 0.5;

  float diskRadius = min(u_cssSize.x, u_cssSize.y) * 0.45 * u_displayZoom;
  vec2 p = fragCss - center;
  float dist = length(p);

  // Reference-like styling
  vec3 diskFill = u_diskFillColor.rgb;
  vec3 diskBorder = u_diskBorderColor.rgb;

  float borderWidth = max(u_diskBorderWidthPx, 0.0);
  float halfW = 0.5 * borderWidth;

  // Anti-aliasing width (CSS px). Keep at least 1px for crisp edges.
  float aa = max(1.0, fwidth(dist));

  // Discard outside disk+border region so the clear color remains intact.
  if (dist > diskRadius + halfW + aa) discard;

  // Outer fade for anti-aliased boundary
  float outerAlpha = 1.0 - smoothstep(diskRadius + halfW - aa, diskRadius + halfW + aa, dist);

  // Border mask
  float borderInner = smoothstep(diskRadius - halfW - aa, diskRadius - halfW + aa, dist);
  float borderOuter = 1.0 - smoothstep(diskRadius + halfW - aa, diskRadius + halfW + aa, dist);
  float borderMask = clamp(borderInner * borderOuter, 0.0, 1.0);

  vec3 col = mix(diskFill, diskBorder, borderMask);

  // ------------------------------------------------------------------------
  // Reference-like hyperbolic grid overlay
  // ------------------------------------------------------------------------
  // Matches HyperbolicReference.drawHyperbolicGrid():
  // - 8 radial lines (geodesics through origin)
  // - 5 concentric circles
  vec3 gridCol = u_gridColor.rgb;
  float gridWidth = max(u_gridWidthPx, 0.0);
  float halfGrid = 0.5 * gridWidth;

  // AA width for thin lines in CSS pixel space.
  float aaLine = max(1.0, fwidth(dist));

  float gridMask = 0.0;

  // Concentric circles (5)
  for (int i = 1; i <= 5; i++) {
    float r = (float(i) / 6.0) * diskRadius;
    float d = abs(dist - r);
    float m = 1.0 - smoothstep(halfGrid - aaLine, halfGrid + aaLine, d);
    gridMask = max(gridMask, m);
  }

  // Radial lines (8), angle = (i/8)*pi
  // Distance to line through origin with direction (cos a, sin a): |cross(p, dir)|
  for (int i = 0; i < 8; i++) {
    float a = (float(i) / 8.0) * 3.141592653589793;
    vec2 dir = vec2(cos(a), sin(a));
    float d = abs(p.x * dir.y - p.y * dir.x);
    float m = 1.0 - smoothstep(halfGrid - aaLine, halfGrid + aaLine, d);
    gridMask = max(gridMask, m);
  }

  // Apply grid on top of disk fill/border. Use u_gridColor alpha as intensity.
  col = mix(col, gridCol, clamp(gridMask, 0.0, 1.0) * clamp(u_gridColor.a, 0.0, 1.0));
  outColor = vec4(col, outerAlpha);
}
`,ei=`#version 300 es
precision highp float;
precision highp int;

layout(location = 0) in vec2 a_pos;
layout(location = 1) in uint a_label;

uniform vec2 u_center;
uniform vec2 u_cssSize;
uniform float u_zoom;
uniform float u_dpr;
uniform float u_pointRadiusCss;

flat out uint v_label;

void main() {
  float baseScale = min(u_cssSize.x, u_cssSize.y) * 0.4 * u_zoom;
  float sx = u_cssSize.x * 0.5 + (a_pos.x - u_center.x) * baseScale;
  float sy = u_cssSize.y * 0.5 - (a_pos.y - u_center.y) * baseScale;

  vec2 dbufSize = u_cssSize * u_dpr;
  vec2 dbuf = vec2(sx, sy) * u_dpr;

  float cx = (dbuf.x / dbufSize.x) * 2.0 - 1.0;
  float cy = 1.0 - (dbuf.y / dbufSize.y) * 2.0;

  gl_Position = vec4(cx, cy, 0.0, 1.0);
  gl_PointSize = (u_pointRadiusCss * 2.0) * u_dpr;
  v_label = a_label;
}
`,ii=`#version 300 es
precision highp float;
precision highp int;

layout(location = 0) in vec2 a_pos;
layout(location = 1) in uint a_label;

uniform vec2 u_cssSize;
uniform float u_dpr;
uniform float u_pointRadiusCss;

uniform vec2 u_a;            // camera translation (ax, ay)
uniform float u_displayZoom; // visual zoom

flat out uint v_label;

vec2 mobiusTransform(vec2 z, vec2 a) {
  // (z - a) / (1 - conj(a) * z)
  vec2 num = z - a;

  // denom = 1 - (ax*zx + ay*zy)  + i * (-(ax*zy - ay*zx))
  float denomX = 1.0 - (a.x * z.x + a.y * z.y);
  float denomY = -(a.x * z.y - a.y * z.x);
  float denomNormSq = denomX * denomX + denomY * denomY;
  if (denomNormSq < 1e-12) {
    // Push outside clip
    return vec2(2.0, 2.0);
  }

  // complex division
  float rx = (num.x * denomX + num.y * denomY) / denomNormSq;
  float ry = (num.y * denomX - num.x * denomY) / denomNormSq;
  return vec2(rx, ry);
}

void main() {
  vec2 w = mobiusTransform(a_pos, u_a);
  float r2 = dot(w, w);
  if (r2 >= 1.0) {
    gl_Position = vec4(2.0, 2.0, 0.0, 1.0);
    gl_PointSize = 0.0;
    v_label = a_label;
    return;
  }

  float diskRadius = min(u_cssSize.x, u_cssSize.y) * 0.45 * u_displayZoom;
  float sx = u_cssSize.x * 0.5 + w.x * diskRadius;
  float sy = u_cssSize.y * 0.5 - w.y * diskRadius;

  vec2 dbufSize = u_cssSize * u_dpr;
  vec2 dbuf = vec2(sx, sy) * u_dpr;

  float cx = (dbuf.x / dbufSize.x) * 2.0 - 1.0;
  float cy = 1.0 - (dbuf.y / dbufSize.y) * 2.0;

  gl_Position = vec4(cx, cy, 0.0, 1.0);
  gl_PointSize = (u_pointRadiusCss * 2.0) * u_dpr;
  v_label = a_label;
}
`;class Ee{constructor(){u(this,"canvas",null);u(this,"width",0);u(this,"height",0);u(this,"deviceDpr",1);u(this,"canvasDpr",1);u(this,"dpr",1);u(this,"dataset",null);u(this,"selection",new Set);u(this,"hoveredIndex",-1);u(this,"pointRadiusCss",3);u(this,"colors",Vt);u(this,"backgroundColor","#0a0a0a");u(this,"poincareDiskFillColor","#141414");u(this,"poincareDiskBorderColor","#666666");u(this,"poincareGridColor","#66666633");u(this,"poincareDiskBorderWidthPx",2);u(this,"poincareGridWidthPx",.5);u(this,"paletteSize",0);u(this,"paletteDirty",!0);u(this,"paletteTex",null);u(this,"paletteTexW",0);u(this,"paletteTexH",0);u(this,"paletteBytes",new Uint8Array(0));u(this,"paletteTexUnit",1);u(this,"scratchIds",[]);u(this,"hoverPosScratch",new Float32Array(2));u(this,"hoverLabScratch",new Uint16Array(1));u(this,"hoverIndexScratch",new Uint32Array(1));u(this,"lastViewChangeTs",0);u(this,"dataIndex",null);u(this,"gl",null);u(this,"vao",null);u(this,"posBuffer",null);u(this,"labelBuffer",null);u(this,"hoverVao",null);u(this,"hoverPosBuffer",null);u(this,"hoverLabelBuffer",null);u(this,"selectionVao",null);u(this,"selectionPosBuffer",null);u(this,"selectionLabelBuffer",null);u(this,"selectionOverlayCount",0);u(this,"selectionEbo",null);u(this,"hoverEbo",null);u(this,"interactionEbo",null);u(this,"interactionCount",0);u(this,"maxBaseDrawPoints",4e6);u(this,"maxGpuUploadPoints",1e7);u(this,"gpuUsesFullDataset",!0);u(this,"gpuPointCount",0);u(this,"policy",{fragmentBudget:1e8,circleBudget:6e7,squareOnRatio:1,squareOffRatio:.75,minPointsDpr:.35});u(this,"renderAsSquares",!1);u(this,"__debugPolicy",null);u(this,"backdropTex",null);u(this,"backdropFbo",null);u(this,"backdropW",0);u(this,"backdropH",0);u(this,"backdropDpr",1);u(this,"backdropZoom",NaN);u(this,"backdropDirty",!0);u(this,"pointsTex",null);u(this,"pointsFbo",null);u(this,"pointsW",0);u(this,"pointsH",0);u(this,"programComposite",null);u(this,"uCompositeTex",null);u(this,"poincareDisk",null);u(this,"pointsCircle",null);u(this,"pointsSquare",null);u(this,"programSolid",null);u(this,"uSolidColor",null);u(this,"uSolidPointSizePx",null);u(this,"uSolidRingThicknessPx",null);u(this,"uSolidRingMode",null);u(this,"uCssSizeSolid",null);u(this,"uDprSolid",null);u(this,"uPointRadiusSolid",null);u(this,"selectionDirty",!0);u(this,"hoverDirty",!0)}markViewChanged(){this.lastViewChangeTs=performance.now()}endInteraction(){this.lastViewChangeTs=0}markBackdropDirty(){this.backdropDirty=!0}uploadPoincareDiskStyleUniforms(){const t=this.gl,e=this.poincareDisk;if(!t||!e)return;const i=z(this.poincareDiskFillColor),s=z(this.poincareDiskBorderColor),n=z(this.poincareGridColor);e.uDiskFillColor&&t.uniform4f(e.uDiskFillColor,i[0],i[1],i[2],i[3]),e.uDiskBorderColor&&t.uniform4f(e.uDiskBorderColor,s[0],s[1],s[2],s[3]),e.uGridColor&&t.uniform4f(e.uGridColor,n[0],n[1],n[2],n[3]),e.uDiskBorderWidthPx&&t.uniform1f(e.uDiskBorderWidthPx,this.poincareDiskBorderWidthPx),e.uGridWidthPx&&t.uniform1f(e.uGridWidthPx,this.poincareGridWidthPx)}getBackdropZoom(){return 1}init(t,e){this.canvas=t,this.width=e.width,this.height=e.height,this.deviceDpr=e.devicePixelRatio??window.devicePixelRatio??1,this.canvasDpr=this.deviceDpr,this.dpr=this.deviceDpr;const i=typeof e.poincareDiskFillColor=="string";e.backgroundColor&&(this.backgroundColor=e.backgroundColor),e.pointRadius&&(this.pointRadiusCss=e.pointRadius),e.colors&&(this.colors=e.colors),this.poincareDiskFillColor=i?e.poincareDiskFillColor:this.poincareDiskFillColor,e.poincareDiskBorderColor&&(this.poincareDiskBorderColor=e.poincareDiskBorderColor),e.poincareGridColor&&(this.poincareGridColor=e.poincareGridColor),typeof e.poincareDiskBorderWidthPx=="number"&&Number.isFinite(e.poincareDiskBorderWidthPx)&&(this.poincareDiskBorderWidthPx=Math.max(0,e.poincareDiskBorderWidthPx)),typeof e.poincareGridWidthPx=="number"&&Number.isFinite(e.poincareGridWidthPx)&&(this.poincareGridWidthPx=Math.max(0,e.poincareGridWidthPx)),this.paletteDirty=!0}chooseRenderDpr(t){const e=this.deviceDpr,i=Math.max(1,this.width)*Math.max(1,this.height),s=t>this.maxBaseDrawPoints?this.estimateSubsampleCount(t):t,n=t>=1e6?i>1e6?2e5:5e5:t>=5e5?14e5:t>=25e4?21e5:8e6,r=Math.sqrt(n/i),a=Math.max(.5,this.pointRadiusCss),c=Math.max(1,s)*Math.PI*a*a,l=Math.sqrt(this.policy.fragmentBudget/c),d=t>=1e6?1:t>=5e5?1.25:1.5,h=t>=1e6?this.policy.minPointsDpr:t>=5e5?.75:1,f=Math.min(e,d,r,l);return Math.max(h,f)}estimateSubsampleCount(t){if(t<5e5)return t;const e=Math.min(t,Math.max(25e4,Math.min(this.maxBaseDrawPoints,Math.floor(t*.25)))),i=Math.max(1,Math.floor(t/e));return Math.min(e,Math.ceil(t/i))}estimatePointFragments(t,e){const i=Math.max(.5,this.pointRadiusCss),s=Math.max(0,t),n=Math.max(0,e);return s*Math.PI*i*i*n*n}updateSquarePointPolicy(t){const e=this.policy.circleBudget*this.policy.squareOnRatio,i=this.policy.circleBudget*this.policy.squareOffRatio;if(this.dpr<=.75){this.renderAsSquares=!0;return}this.renderAsSquares?t<=i&&(this.renderAsSquares=!1):t>=e&&(this.renderAsSquares=!0)}setDataset(t){this.dataset=t,this.selection=new Set,this.hoveredIndex=-1,this.selectionDirty=!0,this.hoverDirty=!0;const e=this.chooseRenderDpr(t.n);e!==this.dpr&&(this.dpr=e),this.dataIndex=new Ze(t.positions,void 0,64),this.gl&&this.uploadDatasetToGPU(),this.markBackdropDirty()}resize(t,e){this.width=t,this.height=e,this.gl&&this.canvas&&(ne(this.canvas,t,e,this.canvasDpr),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.markBackdropDirty())}setSelection(t){const e=t.size;this.selection=e<=2e5?new Set(t):t,this.selectionDirty=!0,this.gl&&this.uploadSelectionToGPU()}getSelection(){return this.selection.size<=2e5?new Set(this.selection):this.selection}setHovered(t){this.hoveredIndex=t,this.hoverDirty=!0,this.gl&&this.uploadHoverToGPU()}destroy(){const t=this.gl;t&&(this.pointsCircle&&t.deleteProgram(this.pointsCircle.program),this.pointsSquare&&t.deleteProgram(this.pointsSquare.program),this.programSolid&&t.deleteProgram(this.programSolid),this.poincareDisk&&t.deleteProgram(this.poincareDisk.program),this.vao&&t.deleteVertexArray(this.vao),this.hoverVao&&t.deleteVertexArray(this.hoverVao),this.selectionVao&&t.deleteVertexArray(this.selectionVao),this.posBuffer&&t.deleteBuffer(this.posBuffer),this.labelBuffer&&t.deleteBuffer(this.labelBuffer),this.hoverPosBuffer&&t.deleteBuffer(this.hoverPosBuffer),this.hoverLabelBuffer&&t.deleteBuffer(this.hoverLabelBuffer),this.selectionPosBuffer&&t.deleteBuffer(this.selectionPosBuffer),this.selectionLabelBuffer&&t.deleteBuffer(this.selectionLabelBuffer),this.selectionEbo&&t.deleteBuffer(this.selectionEbo),this.hoverEbo&&t.deleteBuffer(this.hoverEbo),this.interactionEbo&&t.deleteBuffer(this.interactionEbo),this.backdropFbo&&t.deleteFramebuffer(this.backdropFbo),this.backdropTex&&t.deleteTexture(this.backdropTex),this.pointsFbo&&t.deleteFramebuffer(this.pointsFbo),this.pointsTex&&t.deleteTexture(this.pointsTex),this.paletteTex&&t.deleteTexture(this.paletteTex),this.programComposite&&t.deleteProgram(this.programComposite)),this.gl=null,this.vao=null,this.hoverVao=null,this.selectionVao=null,this.posBuffer=null,this.labelBuffer=null,this.hoverPosBuffer=null,this.hoverLabelBuffer=null,this.selectionPosBuffer=null,this.selectionLabelBuffer=null,this.selectionOverlayCount=0,this.selectionEbo=null,this.hoverEbo=null,this.interactionEbo=null,this.interactionCount=0,this.gpuUsesFullDataset=!0,this.gpuPointCount=0,this.backdropFbo=null,this.backdropTex=null,this.backdropW=0,this.backdropH=0,this.backdropDpr=1,this.backdropZoom=NaN,this.backdropDirty=!0,this.pointsFbo=null,this.pointsTex=null,this.pointsW=0,this.pointsH=0,this.programComposite=null,this.uCompositeTex=null,this.pointsCircle=null,this.pointsSquare=null,this.programSolid=null,this.poincareDisk=null,this.paletteTex=null,this.paletteTexW=0,this.paletteTexH=0,this.paletteSize=0,this.paletteDirty=!0}uploadPaletteUniforms(){const t=this.gl;if(!t)return;const e=this.colors.length,i=Math.max(1,Math.min(e,65536)),s=t.getParameter(t.MAX_TEXTURE_SIZE),n=Math.min(s,i),r=Math.ceil(i/n);if(r>s)throw new Error(`Palette too large for WebGL texture: size=${i}, maxTex=${s}`);const a=n*r;if(this.paletteBytes.length!==a*4?this.paletteBytes=new Uint8Array(a*4):this.paletteBytes.fill(0),e===0)this.paletteBytes[0]=255,this.paletteBytes[1]=255,this.paletteBytes[2]=255,this.paletteBytes[3]=255;else for(let l=0;l<i;l++){const[d,h,f,p]=Ke(this.colors[l]),g=l*4;this.paletteBytes[g+0]=d,this.paletteBytes[g+1]=h,this.paletteBytes[g+2]=f,this.paletteBytes[g+3]=p}if(!this.paletteTex){if(this.paletteTex=t.createTexture(),!this.paletteTex)throw new Error("Failed to create palette texture");t.activeTexture(t.TEXTURE0+this.paletteTexUnit),t.bindTexture(t.TEXTURE_2D,this.paletteTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0)}this.paletteSize=i,this.paletteTexW=n,this.paletteTexH=r,t.activeTexture(t.TEXTURE0+this.paletteTexUnit),t.bindTexture(t.TEXTURE_2D,this.paletteTex),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.texImage2D(t.TEXTURE_2D,0,t.RGBA8,n,r,0,t.RGBA,t.UNSIGNED_BYTE,this.paletteBytes),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE0);const c=l=>{l&&(t.useProgram(l.program),l.uPaletteTex&&t.uniform1i(l.uPaletteTex,this.paletteTexUnit),l.uPaletteSize&&t.uniform1i(l.uPaletteSize,this.paletteSize),l.uPaletteWidth&&t.uniform1i(l.uPaletteWidth,this.paletteTexW))};c(this.pointsCircle),c(this.pointsSquare),this.paletteDirty=!1}bindPaletteTexture(){const t=this.gl;!t||!this.paletteTex||(t.activeTexture(t.TEXTURE0+this.paletteTexUnit),t.bindTexture(t.TEXTURE_2D,this.paletteTex),t.activeTexture(t.TEXTURE0))}async countSelection(t,e={}){const i=this.dataset,s=this.dataIndex;if(!i||!s)return 0;if(t.indices)return t.indices.size;if(t.kind!=="geometry"||!t.geometry)return 0;const n=t.geometry.coords;if(n.length/2<3)return 0;let a=t.geometry.bounds;if(!a){let _=1/0,I=1/0,T=-1/0,L=-1/0;for(let q=0;q<n.length;q+=2){const O=n[q],A=n[q+1];O<_&&(_=O),O>T&&(T=O),A<I&&(I=A),A>L&&(L=A)}a={xMin:_,yMin:I,xMax:T,yMax:L}}const c=e.shouldCancel,l=e.onProgress,d=typeof e.yieldEveryMs=="number"&&Number.isFinite(e.yieldEveryMs)?Math.max(0,e.yieldEveryMs):8,h=1e-12,f=a.xMin-h,p=a.yMin-h,g=a.xMax+h,x=a.yMax+h,m=(_,I,T)=>_<I?I:_>T?T:_|0,b=m(Math.floor((f-s.bounds.minX)/s.cellSizeX),0,s.cellsX-1),S=m(Math.floor((p-s.bounds.minY)/s.cellSizeY),0,s.cellsY-1),v=m(Math.floor((g-s.bounds.minX)/s.cellSizeX),0,s.cellsX-1),E=m(Math.floor((x-s.bounds.minY)/s.cellSizeY),0,s.cellsY-1),R=i.positions,M=s.ids,F=s.offsets;let C=0,P=0;const U=16384;let B=U,k=d>0?performance.now():0;for(let _=S;_<=E;_++){const I=_*s.cellsX;for(let T=b;T<=v;T++){const L=I+T,q=F[L],O=F[L+1];for(let A=q;A<O;A++){const N=M[A],Q=R[N*2],W=R[N*2+1];if(!(Q<a.xMin||Q>a.xMax||W<a.yMin||W>a.yMax)&&(Ft(Q,W,n)&&C++,P++,d>0&&P>=B)){if(B=P+U,c!=null&&c())return C;performance.now()-k>=d&&(l==null||l(C,P),await new Promise(nt=>requestAnimationFrame(()=>nt())),k=performance.now())}}}}return l==null||l(C,P),C}ensureGL(){if(this.gl)return;if(!this.canvas)throw new Error("Renderer not initialized");ne(this.canvas,this.width,this.height,this.canvasDpr);const t=this.canvas.getContext("webgl2",{antialias:!1,alpha:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!1,premultipliedAlpha:!1,desynchronized:!0});if(!t)throw new Error("Failed to get WebGL2 context (is the canvas already using 2D context?)");this.gl=t,t.disable(t.DEPTH_TEST),t.disable(t.CULL_FACE),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const[e,i,s,n]=z(this.backgroundColor);t.clearColor(e,i,s,n),t.viewport(0,0,this.canvas.width,this.canvas.height),this.createProgramsAndBuffers(),this.uploadPaletteUniforms(),this.dataset&&this.uploadDatasetToGPU(),this.uploadSelectionToGPU(),this.uploadHoverToGPU(),this.markBackdropDirty()}ensurePointsResources(){if(!this.gl||!this.canvas)return;const t=this.gl;let e=Math.max(1,Math.floor(this.width*this.dpr)),i=Math.max(1,Math.floor(this.height*this.dpr));const s=t.getParameter(t.MAX_TEXTURE_SIZE);if(e>s||i>s){const n=Math.min(1,s/e,s/i);e=Math.max(1,Math.floor(e*n)),i=Math.max(1,Math.floor(i*n))}if(!this.pointsTex){if(this.pointsTex=t.createTexture(),!this.pointsTex)throw new Error("Failed to create points texture");t.bindTexture(t.TEXTURE_2D,this.pointsTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)}if(!this.pointsFbo&&(this.pointsFbo=t.createFramebuffer(),!this.pointsFbo))throw new Error("Failed to create points framebuffer");if(e!==this.pointsW||i!==this.pointsH){this.pointsW=e,this.pointsH=i,t.bindTexture(t.TEXTURE_2D,this.pointsTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,i,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,this.pointsFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.pointsTex,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(t.bindFramebuffer(t.FRAMEBUFFER,null),n!==t.FRAMEBUFFER_COMPLETE)throw new Error(`Points framebuffer incomplete: ${n}`)}}ensureBackdropResources(){if(!this.gl||!this.canvas||this.geometryKind()!=="poincare"||!this.poincareDisk||!this.vao)return;const t=this.gl,e=Math.max(1,this.canvasDpr);let i=Math.max(1,Math.floor(this.width*e)),s=Math.max(1,Math.floor(this.height*e));const n=t.getParameter(t.MAX_TEXTURE_SIZE);if(i>n||s>n){const r=Math.min(1,n/i,n/s);i=Math.max(1,Math.floor(i*r)),s=Math.max(1,Math.floor(s*r)),this.backdropDpr=e*r}else this.backdropDpr=e;if(!this.backdropTex){if(this.backdropTex=t.createTexture(),!this.backdropTex)throw new Error("Failed to create backdrop texture");t.bindTexture(t.TEXTURE_2D,this.backdropTex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)}if(!this.backdropFbo&&(this.backdropFbo=t.createFramebuffer(),!this.backdropFbo))throw new Error("Failed to create backdrop framebuffer");if(i!==this.backdropW||s!==this.backdropH){this.backdropW=i,this.backdropH=s,t.bindTexture(t.TEXTURE_2D,this.backdropTex),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,i,s,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,this.backdropFbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.backdropTex,0);const r=t.checkFramebufferStatus(t.FRAMEBUFFER);if(t.bindFramebuffer(t.FRAMEBUFFER,null),r!==t.FRAMEBUFFER_COMPLETE)throw new Error(`Backdrop framebuffer incomplete: ${r}`);this.markBackdropDirty()}}renderBackdropIfNeeded(){if(!this.gl||!this.canvas||this.geometryKind()!=="poincare"||!this.poincareDisk||!this.vao||(this.ensureBackdropResources(),!this.backdropFbo))return;const t=this.getBackdropZoom(),e=Number.isFinite(this.backdropZoom)&&Math.abs(this.backdropZoom-t)<=1e-12;if(!this.backdropDirty&&e)return;const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,this.backdropFbo),i.viewport(0,0,this.backdropW,this.backdropH);const[s,n,r,a]=z(this.backgroundColor);i.clearColor(s,n,r,a),i.clear(i.COLOR_BUFFER_BIT),i.useProgram(this.poincareDisk.program),this.bindViewUniformsForProgram(this.poincareDisk.program),this.uploadPoincareDiskStyleUniforms(),this.poincareDisk.uCssSize&&i.uniform2f(this.poincareDisk.uCssSize,this.width,this.height),this.poincareDisk.uDpr&&i.uniform1f(this.poincareDisk.uDpr,this.backdropDpr),i.bindVertexArray(this.vao),i.drawArrays(i.TRIANGLES,0,3),i.bindFramebuffer(i.FRAMEBUFFER,null),i.viewport(0,0,this.canvas.width,this.canvas.height),this.backdropZoom=t,this.backdropDirty=!1}createProgramsAndBuffers(){const t=this.gl,e=this.geometryKind()==="euclidean"?ei:ii,i=xt(t,e,$e),s=xt(t,e,je);if(this.programSolid=xt(t,e,Je),this.programComposite=xt(t,re,Qe),t.useProgram(this.programComposite),this.uCompositeTex=t.getUniformLocation(this.programComposite,"u_tex"),this.geometryKind()==="poincare"){const n=xt(t,re,ti);this.poincareDisk={program:n,uCssSize:t.getUniformLocation(n,"u_cssSize"),uDpr:t.getUniformLocation(n,"u_dpr"),uDiskFillColor:t.getUniformLocation(n,"u_diskFillColor"),uDiskBorderColor:t.getUniformLocation(n,"u_diskBorderColor"),uGridColor:t.getUniformLocation(n,"u_gridColor"),uDiskBorderWidthPx:t.getUniformLocation(n,"u_diskBorderWidthPx"),uGridWidthPx:t.getUniformLocation(n,"u_gridWidthPx")},t.useProgram(n),this.uploadPoincareDiskStyleUniforms()}if(t.useProgram(i),this.pointsCircle={program:i,uPaletteTex:t.getUniformLocation(i,"u_paletteTex"),uPaletteSize:t.getUniformLocation(i,"u_paletteSize"),uPaletteWidth:t.getUniformLocation(i,"u_paletteWidth"),uCssSize:t.getUniformLocation(i,"u_cssSize"),uDpr:t.getUniformLocation(i,"u_dpr"),uPointRadius:t.getUniformLocation(i,"u_pointRadiusCss")},t.useProgram(s),this.pointsSquare={program:s,uPaletteTex:t.getUniformLocation(s,"u_paletteTex"),uPaletteSize:t.getUniformLocation(s,"u_paletteSize"),uPaletteWidth:t.getUniformLocation(s,"u_paletteWidth"),uCssSize:t.getUniformLocation(s,"u_cssSize"),uDpr:t.getUniformLocation(s,"u_dpr"),uPointRadius:t.getUniformLocation(s,"u_pointRadiusCss")},t.useProgram(this.programSolid),this.uSolidColor=t.getUniformLocation(this.programSolid,"u_color"),this.uSolidPointSizePx=t.getUniformLocation(this.programSolid,"u_pointSizePx"),this.uSolidRingThicknessPx=t.getUniformLocation(this.programSolid,"u_ringThicknessPx"),this.uSolidRingMode=t.getUniformLocation(this.programSolid,"u_ringMode"),this.uCssSizeSolid=t.getUniformLocation(this.programSolid,"u_cssSize"),this.uDprSolid=t.getUniformLocation(this.programSolid,"u_dpr"),this.uPointRadiusSolid=t.getUniformLocation(this.programSolid,"u_pointRadiusCss"),this.vao=t.createVertexArray(),this.posBuffer=t.createBuffer(),this.labelBuffer=t.createBuffer(),this.hoverVao=t.createVertexArray(),this.hoverPosBuffer=t.createBuffer(),this.hoverLabelBuffer=t.createBuffer(),this.selectionVao=t.createVertexArray(),this.selectionPosBuffer=t.createBuffer(),this.selectionLabelBuffer=t.createBuffer(),this.selectionEbo=t.createBuffer(),this.hoverEbo=t.createBuffer(),this.interactionEbo=t.createBuffer(),!this.vao||!this.posBuffer||!this.labelBuffer||!this.hoverVao||!this.hoverPosBuffer||!this.hoverLabelBuffer||!this.selectionVao||!this.selectionPosBuffer||!this.selectionLabelBuffer||!this.selectionEbo||!this.hoverEbo||!this.interactionEbo)throw new Error("Failed to allocate WebGL resources");t.bindVertexArray(this.vao),t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.labelBuffer),t.enableVertexAttribArray(1),t.vertexAttribIPointer(1,1,t.UNSIGNED_SHORT,0,0),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(this.hoverVao),t.bindBuffer(t.ARRAY_BUFFER,this.hoverPosBuffer),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.hoverLabelBuffer),t.enableVertexAttribArray(1),t.vertexAttribIPointer(1,1,t.UNSIGNED_SHORT,0,0),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindVertexArray(this.selectionVao),t.bindBuffer(t.ARRAY_BUFFER,this.selectionPosBuffer),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.selectionLabelBuffer),t.enableVertexAttribArray(1),t.vertexAttribIPointer(1,1,t.UNSIGNED_SHORT,0,0),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null)}uploadDatasetToGPU(){const t=this.gl,e=this.dataset;if(!e)return;t.bindVertexArray(this.vao);const i=e.n<=this.maxGpuUploadPoints;if(this.gpuUsesFullDataset=i,i)t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer),t.bufferData(t.ARRAY_BUFFER,e.positions,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.labelBuffer),t.bufferData(t.ARRAY_BUFFER,e.labels,t.STATIC_DRAW),this.gpuPointCount=e.n;else{const s=e.n,n=Math.min(s,Math.max(25e4,Math.min(this.maxBaseDrawPoints,Math.floor(s*.25)))),r=Math.max(1,Math.floor(s/n)),a=Math.min(n,Math.ceil(s/r)),c=new Float32Array(a*2),l=new Uint16Array(a);let d=0;for(let h=0;h<s&&d<a;h+=r)c[d*2]=e.positions[h*2],c[d*2+1]=e.positions[h*2+1],l[d]=e.labels[h],d++;t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer),t.bufferData(t.ARRAY_BUFFER,c,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.labelBuffer),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW),this.gpuPointCount=d}if(this.interactionCount=0,this.interactionEbo&&this.gpuUsesFullDataset){const s=e.n;if(s>=5e5){const n=Math.min(s,Math.max(25e4,Math.min(this.maxBaseDrawPoints,Math.floor(s*.25)))),r=Math.max(1,Math.floor(s/n)),a=Math.min(n,Math.ceil(s/r)),c=new Uint32Array(a);let l=0;for(let d=0;d<s&&l<a;d+=r)c[l++]=d;this.interactionCount=l,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.interactionEbo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,c,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}}t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null)}uploadSelectionToGPU(){if(!this.gl||!this.selectionEbo)return;const t=this.gl,e=25e4;if(!this.gpuUsesFullDataset){const a=this.dataset;if(!a||!this.selectionVao||!this.selectionPosBuffer||!this.selectionLabelBuffer)return;const c=this.selection.size;if(this.selectionOverlayCount=Math.min(c,e),c===0){this.selectionDirty=!1;return}const l=Math.min(c,e),d=new Float32Array(l*2),h=new Uint16Array(l);let f=0;for(const p of this.selection)if(d[f*2]=a.positions[p*2],d[f*2+1]=a.positions[p*2+1],h[f]=a.labels[p],f++,f>=l)break;this.selectionOverlayCount=f,t.bindVertexArray(this.selectionVao),t.bindBuffer(t.ARRAY_BUFFER,this.selectionPosBuffer),t.bufferData(t.ARRAY_BUFFER,d,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.selectionLabelBuffer),t.bufferData(t.ARRAY_BUFFER,h,t.DYNAMIC_DRAW),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this.selectionDirty=!1;return}const i=this.selection.size,s=Math.min(i,e);if(this.selectionOverlayCount=s,s===0){this.selectionDirty=!1;return}const n=new Uint32Array(s);let r=0;for(const a of this.selection)if(n[r++]=a,r>=s)break;this.selectionOverlayCount=r,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.selectionEbo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,n,t.DYNAMIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.selectionDirty=!1}uploadHoverToGPU(){if(!this.gl||!this.hoverEbo)return;const t=this.gl;if(!this.gpuUsesFullDataset){const s=this.dataset;if(!s||!this.hoverVao||!this.hoverPosBuffer||!this.hoverLabelBuffer)return;const n=this.hoveredIndex>=0&&this.hoveredIndex<s.n?this.hoveredIndex:-1,r=this.hoverPosScratch,a=this.hoverLabScratch;n>=0?(r[0]=s.positions[n*2],r[1]=s.positions[n*2+1],a[0]=s.labels[n]):(r[0]=2,r[1]=2,a[0]=0),t.bindVertexArray(this.hoverVao),t.bindBuffer(t.ARRAY_BUFFER,this.hoverPosBuffer),t.bufferData(t.ARRAY_BUFFER,r,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.hoverLabelBuffer),t.bufferData(t.ARRAY_BUFFER,a,t.DYNAMIC_DRAW),t.bindVertexArray(null),t.bindBuffer(t.ARRAY_BUFFER,null),this.hoverDirty=!1;return}const e=this.hoveredIndex>=0?this.hoveredIndex:0,i=this.hoverIndexScratch;i[0]=e,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.hoverEbo),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i,t.DYNAMIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.hoverDirty=!1}render(){this.ensureGL();const t=this.gl,e=this.dataset;if(!e)return;const s=performance.now()-this.lastViewChangeTs<80,n=!!this.interactionEbo&&this.interactionCount>0,a=s&&this.geometryKind()==="poincare"&&e.n>=2e6&&n,c=e.n>this.maxBaseDrawPoints&&n,l=this.gpuUsesFullDataset&&(a||c),d=this.gpuUsesFullDataset?l?this.interactionCount:e.n:this.gpuPointCount,h=this.estimatePointFragments(d,this.dpr);if(this.updateSquarePointPolicy(h),this.selectionDirty&&this.uploadSelectionToGPU(),this.hoverDirty&&this.uploadHoverToGPU(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.canvas.width,this.canvas.height),t.disable(t.BLEND),this.geometryKind()==="poincare")if(this.renderBackdropIfNeeded(),this.backdropTex&&this.programComposite)t.useProgram(this.programComposite),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.backdropTex),this.uCompositeTex&&t.uniform1i(this.uCompositeTex,0),t.bindVertexArray(this.vao),t.drawArrays(t.TRIANGLES,0,3),t.bindTexture(t.TEXTURE_2D,null);else{const[p,g,x,m]=z(this.backgroundColor);t.clearColor(p,g,x,m),t.clear(t.COLOR_BUFFER_BIT)}else{const[p,g,x,m]=z(this.backgroundColor);t.clearColor(p,g,x,m),t.clear(t.COLOR_BUFFER_BIT)}if(this.ensurePointsResources(),!this.pointsFbo||!this.pointsTex||!this.programComposite)return;t.bindFramebuffer(t.FRAMEBUFFER,this.pointsFbo),t.viewport(0,0,this.pointsW,this.pointsH),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT);const f=this.renderAsSquares?this.pointsSquare:this.pointsCircle;if(f){if(t.useProgram(f.program),this.bindViewUniformsForProgram(f.program),this.paletteDirty&&this.uploadPaletteUniforms(),this.bindPaletteTexture(),f.uCssSize&&t.uniform2f(f.uCssSize,this.width,this.height),f.uDpr&&t.uniform1f(f.uDpr,this.dpr),f.uPointRadius&&t.uniform1f(f.uPointRadius,this.pointRadiusCss),this.renderAsSquares?t.disable(t.BLEND):(t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)),t.bindVertexArray(this.vao),l)t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.interactionEbo),t.drawElements(t.POINTS,this.interactionCount,t.UNSIGNED_INT,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);else{const p=this.gpuUsesFullDataset?e.n:this.gpuPointCount;t.drawArrays(t.POINTS,0,p)}if(this.__debugPolicy={pointsDpr:this.dpr,deviceDpr:this.deviceDpr,canvasDpr:this.canvasDpr,renderAsSquares:this.renderAsSquares,useLod:l,baseDrawCount:d,interactionCount:this.interactionCount,gpuUsesFullDataset:this.gpuUsesFullDataset,gpuPointCount:this.gpuPointCount,estimatedPointFragments:h,fragmentBudget:this.policy.fragmentBudget,isInteracting:s},!s&&this.selection.size>0){if(t.useProgram(this.programSolid),this.bindViewUniformsForProgram(this.programSolid),this.uCssSizeSolid&&t.uniform2f(this.uCssSizeSolid,this.width,this.height),this.uDprSolid&&t.uniform1f(this.uDprSolid,this.dpr),this.uPointRadiusSolid&&t.uniform1f(this.uPointRadiusSolid,this.pointRadiusCss+1),this.uSolidColor){const[p,g,x,m]=z(dt);t.uniform4f(this.uSolidColor,p,g,x,m)}this.uSolidRingMode&&t.uniform1i(this.uSolidRingMode,0),this.uSolidRingThicknessPx&&t.uniform1f(this.uSolidRingThicknessPx,0),this.uSolidPointSizePx&&t.uniform1f(this.uSolidPointSizePx,(this.pointRadiusCss+1)*2*this.dpr),this.gpuUsesFullDataset?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.selectionEbo),t.drawElements(t.POINTS,this.selectionOverlayCount,t.UNSIGNED_INT,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)):this.selectionVao&&this.selectionOverlayCount>0&&(t.bindVertexArray(this.selectionVao),t.drawArrays(t.POINTS,0,this.selectionOverlayCount),t.bindVertexArray(this.vao))}if(!s&&this.hoveredIndex>=0&&this.hoveredIndex<e.n){t.useProgram(this.programSolid),this.bindViewUniformsForProgram(this.programSolid),this.uCssSizeSolid&&t.uniform2f(this.uCssSizeSolid,this.width,this.height),this.uDprSolid&&t.uniform1f(this.uDprSolid,this.dpr);const p=this.pointRadiusCss+3;if(this.uPointRadiusSolid&&t.uniform1f(this.uPointRadiusSolid,p),this.uSolidColor){const[x,m,b,S]=z(qt);t.uniform4f(this.uSolidColor,x,m,b,S)}this.uSolidRingMode&&t.uniform1i(this.uSolidRingMode,1),this.uSolidRingThicknessPx&&t.uniform1f(this.uSolidRingThicknessPx,2),this.uSolidPointSizePx&&t.uniform1f(this.uSolidPointSizePx,p*2*this.dpr),this.gpuUsesFullDataset?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.hoverEbo),t.drawElements(t.POINTS,1,t.UNSIGNED_INT,0)):this.hoverVao&&(t.bindVertexArray(this.hoverVao),t.drawArrays(t.POINTS,0,1),t.bindVertexArray(this.vao));const g=this.pointRadiusCss+1;if(this.selection.has(this.hoveredIndex)){if(this.uPointRadiusSolid&&t.uniform1f(this.uPointRadiusSolid,g),this.uSolidColor){const[x,m,b,S]=z(dt);t.uniform4f(this.uSolidColor,x,m,b,S)}this.uSolidRingMode&&t.uniform1i(this.uSolidRingMode,0),this.uSolidRingThicknessPx&&t.uniform1f(this.uSolidRingThicknessPx,0),this.uSolidPointSizePx&&t.uniform1f(this.uSolidPointSizePx,g*2*this.dpr),this.gpuUsesFullDataset?t.drawElements(t.POINTS,1,t.UNSIGNED_INT,0):this.hoverVao&&(t.bindVertexArray(this.hoverVao),t.drawArrays(t.POINTS,0,1),t.bindVertexArray(this.vao))}else{const x=this.pointsCircle;if(!x)return;t.useProgram(x.program),this.bindViewUniformsForProgram(x.program),this.paletteDirty&&this.uploadPaletteUniforms(),this.bindPaletteTexture(),x.uCssSize&&t.uniform2f(x.uCssSize,this.width,this.height),x.uDpr&&t.uniform1f(x.uDpr,this.dpr),x.uPointRadius&&t.uniform1f(x.uPointRadius,g),this.gpuUsesFullDataset?t.drawElements(t.POINTS,1,t.UNSIGNED_INT,0):this.hoverVao&&(t.bindVertexArray(this.hoverVao),t.drawArrays(t.POINTS,0,1),t.bindVertexArray(this.vao))}this.gpuUsesFullDataset&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.canvas.width,this.canvas.height),t.useProgram(this.programComposite),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.pointsTex),this.uCompositeTex&&t.uniform1i(this.uCompositeTex,0),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.bindVertexArray(this.vao),t.drawArrays(t.TRIANGLES,0,3),t.bindVertexArray(this.vao),t.bindTexture(t.TEXTURE_2D,null),t.bindVertexArray(null)}}}class si extends Ee{constructor(){super(...arguments);u(this,"view",pe());u(this,"uniformCache",new Map)}geometryKind(){return"euclidean"}setDataset(e){if(e.geometry!=="euclidean")throw new Error("EuclideanWebGLCandidate only supports euclidean geometry");super.setDataset(e),this.fitToData()}fitToData(){const e=this.dataset;if(!e||e.n===0)return;let i=1/0,s=-1/0,n=1/0,r=-1/0;for(let h=0;h<e.n;h++){const f=e.positions[h*2],p=e.positions[h*2+1];i=Math.min(i,f),s=Math.max(s,f),n=Math.min(n,p),r=Math.max(r,p)}const a=s-i||1,c=r-n||1,d=2/Math.max(a,c);this.view={type:"euclidean",centerX:(i+s)/2,centerY:(n+r)/2,zoom:Math.max(.1,Math.min(100,d))}}setView(e){if(e.type!=="euclidean")throw new Error("EuclideanWebGLCandidate only supports euclidean view state");this.view=e}getView(){return{...this.view}}bindViewUniformsForProgram(e){if(!this.gl)return;const i=this.gl;let s=this.uniformCache.get(e);s||(s={uCenter:i.getUniformLocation(e,"u_center"),uZoom:i.getUniformLocation(e,"u_zoom")},this.uniformCache.set(e,s)),s.uCenter&&i.uniform2f(s.uCenter,this.view.centerX,this.view.centerY),s.uZoom&&i.uniform1f(s.uZoom,this.view.zoom)}pan(e,i,s){this.view=xe(this.view,e,i,this.width,this.height),this.markViewChanged()}zoom(e,i,s,n){this.view=ge(this.view,e,i,s,this.width,this.height),this.markViewChanged()}hitTest(e,i){const s=this.dataset,n=this.dataIndex;if(!s||!n)return null;const r=this.pointRadiusCss+5,a=r*r,c=Math.min(this.width,this.height)*.4*this.view.zoom;if(!(c>0))return null;const l=r/c*(1+1e-12),d=l*l,h=lt(e,i,this.view,this.width,this.height),f=this.width*.5,p=this.height*.5,g=this.view.centerX,x=this.view.centerY;let m=-1,b=1/0;if(n.forEachInAABB(h.x-l,h.y-l,h.x+l,h.y+l,R=>{const M=s.positions[R*2],F=s.positions[R*2+1],C=M-h.x,P=F-h.y;if(C*C+P*P>d)return;const B=f+(M-g)*c,k=p-(F-x)*c,_=B-e,I=k-i,T=_*_+I*I;T<=a&&(T<b||T===b&&R<m)&&(b=T,m=R)}),m<0)return null;const S=s.positions[m*2],v=s.positions[m*2+1],E=K(S,v,this.view,this.width,this.height);return{index:m,screenX:E.x,screenY:E.y,distance:Math.sqrt(b)}}lassoSelect(e){const i=this.dataset,s=this.dataIndex;if(!i||!s)return ut(new Set,0);const n=performance.now(),r=new Float32Array(e.length);for(let g=0;g<e.length/2;g++){const x=e[g*2],m=e[g*2+1],b=lt(x,m,this.view,this.width,this.height);r[g*2]=b.x,r[g*2+1]=b.y}let a=1/0,c=1/0,l=-1/0,d=-1/0;for(let g=0;g<r.length;g+=2){const x=r[g],m=r[g+1];x<a&&(a=x),x>l&&(l=x),m<c&&(c=m),m>d&&(d=m)}const h={xMin:a,yMin:c,xMax:l,yMax:d},f={type:"polygon",coords:r,bounds:h},p=performance.now()-n;return me(f,i.positions,p,(g,x,m)=>g<h.xMin||g>h.xMax||x<h.yMin||x>h.yMax?!1:Ft(g,x,m))}projectToScreen(e,i){return K(e,i,this.view,this.width,this.height)}unprojectFromScreen(e,i){return lt(e,i,this.view,this.width,this.height)}}class oi extends Ee{constructor(){super(...arguments);u(this,"view",Mt());u(this,"uniformCache",new Map);u(this,"lastPanScreenX",0);u(this,"lastPanScreenY",0);u(this,"hasPanAnchor",!1)}geometryKind(){return"poincare"}getBackdropZoom(){return this.view.displayZoom}setDataset(e){if(e.geometry!=="poincare")throw new Error("HyperbolicWebGLCandidate only supports poincare geometry");super.setDataset(e),this.view=Mt(),this.hasPanAnchor=!1}setView(e){if(e.type!=="poincare")throw new Error("HyperbolicWebGLCandidate only supports poincare view state");this.view=e,this.markBackdropDirty()}getView(){return{...this.view}}bindViewUniformsForProgram(e){if(!this.gl)return;const i=this.gl;let s=this.uniformCache.get(e);s||(s={uA:i.getUniformLocation(e,"u_a"),uDisplayZoom:i.getUniformLocation(e,"u_displayZoom")},this.uniformCache.set(e,s)),s.uA&&i.uniform2f(s.uA,this.view.ax,this.view.ay),s.uDisplayZoom&&i.uniform1f(s.uDisplayZoom,this.view.displayZoom)}startPan(e,i){this.lastPanScreenX=e,this.lastPanScreenY=i,this.hasPanAnchor=!0}pan(e,i,s){this.hasPanAnchor||(this.lastPanScreenX=this.width/2,this.lastPanScreenY=this.height/2,this.hasPanAnchor=!0);const n=this.lastPanScreenX,r=this.lastPanScreenY,a=n+e,c=r+i;this.view=Ot(this.view,n,r,a,c,this.width,this.height),this.markViewChanged(),this.lastPanScreenX=a,this.lastPanScreenY=c}zoom(e,i,s,n){this.view=Se(this.view,e,i,s,this.width,this.height),this.markViewChanged(),this.markBackdropDirty()}mobiusDerivativeScaleAt(e,i){const s=this.view.ax,n=this.view.ay,r=s*s+n*n,a=1-(s*e+n*i),c=-(s*i-n*e),l=a*a+c*c;return l<1e-12?0:Math.max(0,1-r)/l}conservativeDataRadiusForScreenRadius(e,i,s,n){const r=this.view.ax,a=this.view.ay,c=r*r+a*a,l=Math.sqrt(c),d=Math.max(1e-12,1-c);if(!(n>1e-9)||!(s>0))return 0;const h=1-(r*e+a*i),f=-(r*i-a*e),p=Math.sqrt(h*h+f*f);if(!Number.isFinite(p)||p<1e-12)return 2;const g=s/(n*d);let x=g*p*p;for(let m=0;m<5;m++){const b=p+l*x;x=g*b*b}return Number.isFinite(x)?(x*=1.001,Math.min(1.999,Math.max(0,x))):2}hitTest(e,i){const s=this.dataset,n=this.dataIndex;if(!s||!n)return null;const{width:r,height:a,view:c}=this,l=r/2,d=a/2,h=Math.min(r,a)*.45*c.displayZoom,f=h*h,p=this.pointRadiusCss+5,g=p*p,x=e-l,m=i-d,b=h+p;if(x*x+m*m>b*b)return null;const S=ct(e,i,c,r,a),v=this.conservativeDataRadiusForScreenRadius(S.x,S.y,p,h);let E=-1,R=1/0;const M=c.ax,F=c.ay;if(n.forEachInAABB(S.x-v,S.y-v,S.x+v,S.y+v,A=>{const N=s.positions[A*2],Q=s.positions[A*2+1],W=N-M,ot=Q-F,nt=1-(M*N+F*Q),Rt=-(M*Q-F*N),kt=nt*nt+Rt*Rt;let H=0,Z=0;if(kt<1e-12){const rt=Math.sqrt(W*W+ot*ot);rt<1e-12?(H=0,Z=0):(H=W/rt*.999,Z=ot/rt*.999)}else{H=(W*nt+ot*Rt)/kt,Z=(ot*nt-W*Rt)/kt;const rt=H*H+Z*Z;if(rt>=1){const se=Math.sqrt(rt);H=H/se*.999,Z=Z/se*.999}}const jt=l+H*h,Jt=d-Z*h,Qt=jt-l,te=Jt-d;if(Qt*Qt+te*te>f)return;const ee=jt-e,ie=Jt-i,vt=ee*ee+ie*ie;vt<=g&&(vt<R||vt===R&&A<E)&&(R=vt,E=A)}),E<0)return null;const C=s.positions[E*2],P=s.positions[E*2+1],U=C-M,B=P-F,k=1-(M*C+F*P),_=-(M*P-F*C),I=k*k+_*_;let T=0,L=0;if(I<1e-12){const A=Math.sqrt(U*U+B*B);A<1e-12?(T=0,L=0):(T=U/A*.999,L=B/A*.999)}else{T=(U*k+B*_)/I,L=(B*k-U*_)/I;const A=T*T+L*L;if(A>=1){const N=Math.sqrt(A);T=T/N*.999,L=L/N*.999}}const q=l+T*h,O=d-L*h;return{index:E,screenX:q,screenY:O,distance:Math.sqrt(R)}}lassoSelect(e){const i=this.dataset,s=this.dataIndex;if(!i||!s)return ut(new Set,0);const n=performance.now(),r=new Float32Array(e.length);for(let g=0;g<e.length/2;g++){const x=e[g*2],m=e[g*2+1],b=ct(x,m,this.view,this.width,this.height);r[g*2]=b.x,r[g*2+1]=b.y}let a=1/0,c=1/0,l=-1/0,d=-1/0;for(let g=0;g<r.length;g+=2){const x=r[g],m=r[g+1];x<a&&(a=x),x>l&&(l=x),m<c&&(c=m),m>d&&(d=m)}const h={xMin:a,yMin:c,xMax:l,yMax:d},f={type:"polygon",coords:r,bounds:h},p=performance.now()-n;return me(f,i.positions,p,(g,x,m)=>g<h.xMin||g>h.xMax||x<h.yMin||x>h.yMax?!1:Ft(g,x,m))}projectToScreen(e,i){return tt(e,i,this.view,this.width,this.height)}unprojectFromScreen(e,i){return ct(e,i,this.view,this.width,this.height)}}function ni(o){let t=1/0,e=1/0,i=-1/0,s=-1/0;for(let n=0;n<o.length;n+=2){const r=o[n],a=o[n+1];r<t&&(t=r),r>i&&(i=r),a<e&&(e=a),a>s&&(s=a)}return!Number.isFinite(t)||!Number.isFinite(e)?{xMin:0,yMin:0,xMax:0,yMax:0}:{xMin:t,yMin:e,xMax:i,yMax:s}}function ri(o,t){let e=Array.from(o),i=Math.floor(e.length/2);if(i<3)return e;for(let s=0;s<t&&(i=Math.floor(e.length/2),!(i<3));s++){const n=new Array(i*4);let r=0;for(let a=0;a<i;a++){const c=a,l=(a+1)%i,d=e[c*2],h=e[c*2+1],f=e[l*2],p=e[l*2+1];n[r++]=.75*d+.25*f,n[r++]=.75*h+.25*p,n[r++]=.25*d+.75*f,n[r++]=.25*h+.75*p}e=n}return e}function Re(o,t){const e=Math.floor(o.length/2);if(e<=t)return new Float32Array(o);const i=2048;let s=o;if(e>i){const g=new Float32Array(i*2);for(let x=0;x<i;x++){const m=Math.floor(x*e/i);g[x*2]=o[m*2],g[x*2+1]=o[m*2+1]}s=g}const n=ri(s,5),r=ni(n),a=Math.max(r.xMax-r.xMin,r.yMax-r.yMin),c=(g,x,m,b,S,v)=>{const E=S-m,R=v-b,M=g-m,F=x-b,C=E*E+R*R;let P=0;C>1e-12&&(P=(M*E+F*R)/C,P<0?P=0:P>1&&(P=1));const U=m+P*E,B=b+P*R,k=g-U,_=x-B;return k*k+_*_},l=g=>{const x=Math.floor(n.length/2);if(x<=2)return n.slice();const m=g*g,b=new Uint8Array(x);b[0]=1,b[x-1]=1;const S=[0,x-1];for(;S.length>0;){const E=S.pop(),R=S.pop(),M=n[R*2],F=n[R*2+1],C=n[E*2],P=n[E*2+1];let U=-1,B=-1;for(let k=R+1;k<E;k++){const _=n[k*2],I=n[k*2+1],T=c(_,I,M,F,C,P);T>U&&(U=T,B=k)}U>m&&B>=0&&(b[B]=1,S.push(R,B),S.push(B,E))}const v=[];for(let E=0;E<x;E++)b[E]&&v.push(n[E*2],n[E*2+1]);return v};let d=Math.max(1e-12,a/100),h=l(d),f=0;for(;Math.floor(h.length/2)>t&&f<20;)d*=1.1,h=l(d),f++;const p=Math.floor(h.length/2);if(p>t){const g=new Float32Array(t*2);for(let x=0;x<t;x++){const m=Math.floor(x*p/t);g[x*2]=h[m*2],g[x*2+1]=h[m*2+1]}return g}return new Float32Array(h)}let w=document.getElementById("canvas");const D=document.getElementById("overlayCanvas"),Ht=document.getElementById("canvasBody"),ae=document.getElementById("canvasHeader"),ai=Array.from(document.querySelectorAll('input[name="renderer"]')),li=Array.from(document.querySelectorAll('input[name="geometry"]')),Zt=document.getElementById("numPoints"),ci=document.getElementById("numPointsLabel"),_t=document.getElementById("datasetMode"),ft=document.getElementById("labelCount"),mt=document.getElementById("labelCountLabel"),ve=document.getElementById("seed"),le=document.getElementById("modeIndicator"),hi=document.getElementById("statPoints"),pt=document.getElementById("statSelected"),Ut=document.getElementById("statHovered"),Ct=document.getElementById("statFrameTime"),Te=document.getElementById("statLassoTime");let y=null,gt=null,ce="",Kt="euclidean",At="webgl",bt="pan";const he=[1e3,1e4,5e4,1e5,25e4,5e5,1e6,2e6,5e6,1e7,2e7];let Et=!1,j=!1,Lt=0,Xt=0;const di=24,ui=24,de=2;let et=[],$=null,Yt=0,zt=0,yt=!1,it=null;function Pe(o){if(!y)return o;const t=o.length/2,e=new Float32Array(o.length);for(let i=0;i<t;i++){const s=o[i*2],n=o[i*2+1],r=y.projectToScreen(s,n);e[i*2]=r.x,e[i*2+1]=r.y}return e}let st=0;async function fi(o,t){if(!y)return;const e=await y.countSelection(t,{shouldCancel:()=>o!==st,onProgress:i=>{o===st&&(pt.textContent=`${i.toLocaleString()} (computing)`)},yieldEveryMs:8});o===st&&(pt.textContent=e.toLocaleString())}let Nt=!1,Wt=!1,wt=0,G=0,V=0,Bt={shift:!1,ctrl:!1,alt:!1,meta:!1},_e=0,we=0,St=!1,ue=0;const at=[],ht=[];window.__vizDemo={getRenderer:()=>y,getView:()=>y?y.getView():null,getCanvasSize:()=>({cssWidth:w.clientWidth,cssHeight:w.clientHeight,bufferWidth:w.width,bufferHeight:w.height})};function mi(){const o=document.createElement("canvas");return o.id="canvas",w.replaceWith(o),w=o,w.addEventListener("mousedown",Fe),w.addEventListener("mousemove",Be),w.addEventListener("mouseup",Dt),w.addEventListener("mouseleave",Dt),w.addEventListener("wheel",ke,{passive:!1}),w.addEventListener("dblclick",Ie),o}function pi(){const o=getComputedStyle(document.documentElement),t=(e,i)=>o.getPropertyValue(e).trim()||i;return{backgroundColor:t("--viz-bg","#13171f"),diskFillColor:t("--viz-disk","#1b2230"),diskBorderColor:t("--viz-border","#6b7280"),gridColor:t("--viz-grid","#2b334266")}}function Me(o,t){y&&y.destroy(),(At!==t||t==="webgl"&&!w.getContext("webgl2")||t==="reference"&&!w.getContext("2d"))&&mi();const i=Ht.getBoundingClientRect(),s=Math.floor(i.width),n=Math.floor(i.height);Ce(s,n),t==="webgl"?(o==="euclidean"?y=new si:y=new oi,ae.textContent="WebGL"):(o==="euclidean"?y=new Ge:y=new qe,ae.textContent="Reference");const r=pi();y.init(w,{width:s,height:n,devicePixelRatio:window.devicePixelRatio,backgroundColor:r.backgroundColor,poincareDiskFillColor:r.diskFillColor,poincareDiskBorderColor:r.diskBorderColor,poincareGridColor:r.gridColor}),Kt=o,At=t}function Ce(o,t){D.width=Math.max(1,Math.floor(o*1)),D.height=Math.max(1,Math.floor(t*1)),D.style.width=`${o}px`,D.style.height=`${t}px`;const i=D.getContext("2d");i&&(i.setTransform(1,0,0,1,0,0),i.clearRect(0,0,o,t))}function xi(){const o=document.querySelector('input[name="geometry"]:checked');return(o==null?void 0:o.value)??"euclidean"}function gi(){const o=document.querySelector('input[name="renderer"]:checked');return(o==null?void 0:o.value)??"webgl"}function bi(){return(_t==null?void 0:_t.value)??"default"}function yi(o){return o>=1e6?`${o/1e6}M`:o>=1e3?`${o/1e3}K`:`${o}`}function Ae(){const o=Math.max(0,Math.min(he.length-1,parseInt(Zt.value,10)||0));return he[o]}function $t(){ci.textContent=yi(Ae())}let Pt=null;function J(){Pt!==null&&window.clearTimeout(Pt),Pt=window.setTimeout(()=>{Pt=null,De()},150)}function De(){const o=gi(),t=xi(),e=Ae(),i=parseInt(ft.value,10),s=parseInt(ve.value,10),n=bi(),r=`${t}/${n}/${e}/${i}/${s}`,a=!gt||r!==ce;st++,(Kt!==t||At!==o||!y)&&Me(t,o),a&&(gt=Ne({seed:s,n:e,labelCount:i,geometry:t,distribution:n}),ce=r),y.setDataset(gt),hi.textContent=e.toLocaleString(),pt.textContent="0",Ut.textContent="-",Ct.textContent="",Ct.style.color="",Te.textContent="",at.length=0,ht.length=0,wt=0;{D.style.display="none";const c=D.getContext("2d");if(c){const l=Ht.getBoundingClientRect();c.clearRect(0,0,l.width,l.height)}}X()}function X(){Wt=!0,!Nt&&(Nt=!0,requestAnimationFrame(Si))}function Si(o){Nt=!1,wt!==0&&(ht.push(o-wt),ht.length>60&&ht.shift()),wt=o,Wt&&(Wt=!1,Ei()),(Et||j||St)&&X()}function Ei(){if(!y)return;if(y&&(G!==0||V!==0)&&(y.pan(G,V,Bt),G=0,V=0),!Et&&!j&&St&&y){const i=y.hitTest(_e,we);i?(y.setHovered(i.index),Ut.textContent=`#${i.index}`):(y.setHovered(-1),Ut.textContent="-"),St=!1}const o=performance.now();y.render();const e=performance.now()-o;if(at.push(e),at.length>60&&at.shift(),ue++,ue%10===0){const i=at.reduce((r,a)=>r+a,0)/Math.max(1,at.length),s=ht.reduce((r,a)=>r+a,0)/Math.max(1,ht.length),n=s>1e-6?1e3/s:0;Ct.textContent=`fps ${n.toFixed(1)}  cpu ${i.toFixed(2)}ms`,Ct.style.color=n>=50?"#8b8":"#b66"}if(j&&yt&&(yt=!1,et.length>=6?$=Re(et,di):$=null),j&&$&&$.length>=6)fe($);else if(it&&it.length>=6)fe(it);else{D.style.display="none";const i=D.getContext("2d");i&&i.clearRect(0,0,D.width,D.height)}}function Ri(o){D.style.display="block";const t=D.getContext("2d");if(!t)return;const e=D.width,i=D.height;if(t.clearRect(0,0,e,i),!(o.length<6)){t.strokeStyle="#cccccc",t.lineWidth=2,t.setLineDash([5,5]),t.beginPath(),t.moveTo(o[0],o[1]);for(let s=2;s<o.length;s+=2)t.lineTo(o[s],o[s+1]);t.closePath(),t.stroke(),t.fillStyle="rgba(255, 255, 255, 0.06)",t.fill()}}function fe(o){!y||o.length/2<3||Ri(Pe(o))}function Gt(){le.textContent=bt.toUpperCase(),le.className=`mode ${bt}`}function Fe(o){const t=w.getBoundingClientRect(),e=o.clientX-t.left,i=o.clientY-t.top;Lt=e,Xt=i;const s=o.shiftKey&&(o.metaKey||o.ctrlKey);if(!s&&!o.shiftKey&&!o.ctrlKey&&!o.altKey&&!o.metaKey&&it&&(it=null,st++,X()),s){if(!y)return;bt="lasso",j=!0,D.style.display="block";const n=y.unprojectFromScreen(e,i);et=[n.x,n.y],$=null,Yt=e,zt=i,yt=!0,pt.textContent="0",Gt(),X()}else bt="pan",Et=!0,Gt(),G=0,V=0,Bt={shift:o.shiftKey,ctrl:o.ctrlKey,alt:o.altKey,meta:o.metaKey},y&&"startPan"in y&&y.startPan(e,i),X()}function Be(o){const t=w.getBoundingClientRect(),e=o.clientX-t.left,i=o.clientY-t.top;if(Et&&y){const s=e-Lt,n=i-Xt;G+=s,V+=n,Bt={shift:o.shiftKey,ctrl:o.ctrlKey,alt:o.altKey,meta:o.metaKey},Lt=e,Xt=i,X()}else if(j){const s=e-Yt,n=i-zt;if(s*s+n*n>=de*de){if(y){const r=y.unprojectFromScreen(e,i);et.push(r.x,r.y),yt=!0}Yt=e,zt=i}X()}else y&&(_e=e,we=i,St=!0,X())}function Dt(o){if(y&&(G!==0||V!==0)&&(y.pan(G,V,Bt),G=0,V=0),j&&y&&et.length>=6){const t=$??Re(et,ui),e=Pe(t),i=y.lassoSelect(e);it=t,y.setSelection(new Set),pt.textContent="";const s=++st;fi(s,i),Te.textContent=`${i.computeTimeMs.toFixed(2)}ms`}Et=!1,j=!1,et=[],$=null,yt=!1,G=0,V=0,St=!1,y&&"endInteraction"in y&&y.endInteraction(),bt="pan",Gt(),X()}function ke(o){if(o.preventDefault(),!y)return;const t=w.getBoundingClientRect(),e=o.clientX-t.left,i=o.clientY-t.top,s=-o.deltaY/100;y.zoom(e,i,s,{shift:o.shiftKey,ctrl:o.ctrlKey,alt:o.altKey,meta:o.metaKey}),X()}function Ie(){if(!y)return;st++,y.setSelection(new Set),pt.textContent="0",it=null,D.style.display="none";const o=D.getContext("2d");o&&o.clearRect(0,0,D.width,D.height),X()}function vi(){if(!y)return;const o=Ht.getBoundingClientRect(),t=Math.floor(o.width),e=Math.floor(o.height);y.resize(t,e),Ce(t,e),X()}w.addEventListener("mousedown",Fe);w.addEventListener("mousemove",Be);w.addEventListener("mouseup",Dt);w.addEventListener("mouseleave",Dt);w.addEventListener("wheel",ke,{passive:!1});w.addEventListener("dblclick",Ie);window.addEventListener("resize",vi);for(const o of li)o.addEventListener("change",J);for(const o of ai)o.addEventListener("change",J);_t.addEventListener("change",J);Zt.addEventListener("input",()=>{$t(),J()});Zt.addEventListener("change",()=>{$t(),J()});ft.addEventListener("input",()=>{mt&&(mt.textContent=ft.value),J()});ft.addEventListener("change",()=>{mt&&(mt.textContent=ft.value),J()});ve.addEventListener("change",J);window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",()=>{y&&(Me(Kt,At),gt&&y.setDataset(gt),X())});$t();mt&&(mt.textContent=ft.value);De();console.log("Viz Lab initialized");
//# sourceMappingURL=main-CKkTA75B.js.map
